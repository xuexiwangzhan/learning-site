<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä¸€å¹´çº§æ•°å­¦ Â· ä¸–ç•Œä¸€ï¼šæ•°æ•°ç‹å›½</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: radial-gradient(circle at top, #020617, #020617 40%, #000 100%);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px 10px 40px;
    }
    .container {
      width: 100%;
      max-width: 900px;
    }
    a.back {
      display: inline-block;
      margin-bottom: 8px;
      font-size: 13px;
      color: #38bdf8;
      text-decoration: none;
    }
    a.back:hover { text-decoration: underline; }

    h1 {
      margin: 4px 0;
      font-size: 24px;
    }
    .subtitle {
      font-size: 14px;
      color: #9ca3af;
      margin-bottom: 16px;
      line-height: 1.6;
    }

    .card {
      background: rgba(15,23,42,0.96);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 16px 40px rgba(15,23,42,0.9);
      border: 1px solid #1f2937;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 14px;
      color: #9ca3af;
      margin-bottom: 10px;
    }
    .badge-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      font-size: 12px;
      color: #cbd5f5;
    }
    .badge-pill span.level {
      font-weight: bold;
      color: #facc15;
    }

    .difficulty-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
      font-size: 13px;
      align-items: center;
    }
    .diff-label {
      color: #9ca3af;
    }
    .diff-btn {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      padding: 4px 10px;
      font-size: 13px;
      cursor: pointer;
      transition: all .15s ease;
    }
    .diff-btn.active {
      background: #2563eb;
      border-color: #60a5fa;
      color: #fff;
    }
    .diff-btn.cleared::after {
      content: " âœ”";
      color: #4ade80;
      font-size: 11px;
    }

    .challenge-zone {
      margin-bottom: 12px;
      padding: 8px 10px;
      border-radius: 12px;
      background: #020617;
      border: 1px dashed #374151;
      font-size: 13px;
      color: #9ca3af;
    }
    .challenge-zone button {
      margin-bottom: 6px;
    }
    .challenge-status {
      margin-bottom: 4px;
    }
    .leaderboard {
      font-size: 12px;
      color: #9ca3af;
      line-height: 1.4;
    }

    .board {
      margin: 6px 0 12px;
      border-radius: 14px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 14px;
    }
    .prompt {
      font-size: 15px;
      margin-bottom: 8px;
    }
    .scene {
      min-height: 80px;
      border-radius: 10px;
      border: 1px solid #111827;
      background: radial-gradient(circle at top, #0f172a, #020617);
      padding: 10px;
      margin-bottom: 10px;
    }

    /* å°æ˜Ÿæ˜Ÿåœºæ™¯ */
    .star-grid {
      display: grid;
      grid-template-columns: repeat(5, 28px);
      gap: 6px;
      justify-content: center;
    }
    .star {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #fee2e2, #f97316);
      box-shadow: 0 0 6px rgba(251,191,36,0.8);
    }

    /* å½©è‰²å°çƒåœºæ™¯ */
    .ball-row {
      display: flex;
      gap: 8px;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }
    .ball {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: 2px solid #111827;
      box-shadow: 0 0 4px rgba(148,163,184,0.6);
    }

    /* æ•°è½´åœºæ™¯ */
    .number-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
      padding: 6px 4px 0;
    }
    .number-tick {
      text-align: center;
      flex: 1;
      font-size: 12px;
      color: #9ca3af;
      position: relative;
    }
    .number-tick span {
      display: inline-block;
      min-width: 18px;
      padding: 2px 0;
      border-radius: 999px;
    }
    .number-tick.start span {
      background: #38bdf8;
      color: #0f172a;
    }
    .number-tick.target span {
      background: #4ade80;
      color: #022c22;
    }
    .number-line-base {
      height: 1px;
      background: #4b5563;
      margin-top: 4px;
    }

    /* åå‡ çš„ç«è½¦åœºæ™¯ */
    .teen-train {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 10px;
      margin-top: 4px;
    }
    .ten-block, .one-block {
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 4px;
    }
    .ten-block-title, .one-block-title {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 2px;
      text-align: center;
    }
    .ten-grid {
      display: grid;
      grid-template-columns: repeat(5, 10px);
      gap: 3px;
      justify-content: center;
    }
    .ten-cell {
      width: 10px;
      height: 10px;
      border-radius: 2px;
      background: #22c55e;
    }
    .ones-row {
      display: flex;
      gap: 4px;
      justify-content: center;
    }
    .one-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #fbbf24;
      box-shadow: 0 0 4px rgba(250,204,21,0.8);
    }

    .tip-text {
      font-size: 13px;
      color: #9ca3af;
      white-space: pre-line;
    }

    .num-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin: 8px 0;
    }
    .num-btn {
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 16px;
      padding: 8px 0;
      cursor: pointer;
      transition: all .15s ease;
    }
    .num-btn:hover {
      background: #0b1120;
      border-color: #38bdf8;
    }
    .num-btn.correct {
      background: #16a34a;
      border-color: #22c55e;
      color: #e5fdf0;
    }
    .num-btn.wrong {
      background: #7f1d1d;
      border-color: #ef4444;
      color: #fee2e2;
    }

    .feedback {
      min-height: 40px;
      font-size: 14px;
      margin-top: 4px;
      line-height: 1.4;
    }
    .feedback.ok { color: #4ade80; }
    .feedback.bad { color: #fecaca; }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    .btn {
      border-radius: 999px;
      padding: 6px 16px;
      font-size: 14px;
      border: none;
      cursor: pointer;
      transition: all .15s ease;
    }
    .btn-main {
      background: #2563eb;
      color: #fff;
    }
    .btn-main:disabled {
      background: #1f2937;
      color: #6b7280;
      cursor: not-allowed;
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid #4b5563;
      color: #9ca3af;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    @media (max-width: 640px) {
      .num-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- å¦‚æœä½ æœ‰ math.htmlï¼Œå°±èƒ½è¿”å›ï¼›æ²¡æœ‰ä¹Ÿæ²¡å…³ç³»ï¼Œåªæ˜¯ç‚¹å‡»ä¼š 404 -->
    <a href="math.html" class="back">âª è¿”å›æ•°å­¦å­¦ä¹ ä¸­å¿ƒ</a>

    <h1>ä¸€å¹´çº§æ•°å­¦ Â· ä¸–ç•Œä¸€ï¼šæ•°æ•°ç‹å›½</h1>
    <div class="subtitle">
      åœ¨æ•°æ•°ç‹å›½é‡Œï¼Œå­©å­è¦å­¦ä¼šï¼š<br/>
      â— çœ‹å›¾æ•°ä¸€æ•°ï¼š0ï½10 ä¸ªç‰©ä½“<br/>
      â— åˆ†æ¸…â€œæœ‰å‡ ä¸ªâ€å’Œâ€œç¬¬å‡ ä¸ªâ€<br/>
      â— åœ¨æ•°è½´ä¸Šå¾€å‰è·³å‡ æ­¥<br/>
      â— ç†è§£â€œåå‡ â€æ˜¯ 1 ä¸ªåå†åŠ å‡ ä¸ªä¸€<br/>
      ä¸‰ä¸ªç­‰çº§å¾ªåºæ¸è¿›ï¼Œå…¨éƒ¨é€šå…³åï¼Œä¼šè§£é” 60 ç§’æŒ‘æˆ˜æ¨¡å¼ã€‚
    </div>

    <div class="card">
      <div class="top-bar">
        <div class="badge-pill">
          å½“å‰æ¨¡å¼ï¼š
          <span class="level" id="level-label">Lv.1 ç®€å• Â· æ•°ä¸€æ•° 0ï½5</span>
        </div>
        <div class="badge-pill">
          æœ¬ç­‰çº§è¿›åº¦ï¼š<span id="level-progress">0 / 5</span>
        </div>
        <div class="badge-pill">
          æ€»å¾—åˆ†ï¼š<span id="total-score">0</span>
        </div>
      </div>

      <!-- éš¾åº¦é€‰æ‹© -->
      <div class="difficulty-row">
        <span class="diff-label">é€‰æ‹©ç­‰çº§ï¼š</span>
        <button class="diff-btn active" data-level="0" id="btn-level-0">ç®€å•</button>
        <button class="diff-btn" data-level="1" id="btn-level-1">ä¸­ç­‰</button>
        <button class="diff-btn" data-level="2" id="btn-level-2">å›°éš¾</button>
      </div>

      <!-- æŒ‘æˆ˜æ¨¡å¼ -->
      <div class="challenge-zone">
        <button class="btn btn-ghost" id="btn-challenge" disabled>
          ğŸ”’ æŒ‘æˆ˜æ¨¡å¼ï¼šå®Œæˆä¸‰ä¸ªç­‰çº§åè§£é”
        </button>
        <div class="challenge-status" id="challenge-status">
          æ¯ä¸ªç­‰çº§ç­”å¯¹ 5 é¢˜åï¼Œå°†è§£é” 60 ç§’æŒ‘æˆ˜æ¨¡å¼ã€‚
        </div>
        <div class="leaderboard" id="leaderboard">
          æŒ‘æˆ˜æ’è¡Œæ¦œï¼šè¿˜æ²¡æœ‰è®°å½•ï¼Œç­‰ä½ æ¥æŒ‘æˆ˜ï¼
        </div>
      </div>

      <!-- ä¸»æ¸¸æˆåŒºåŸŸ -->
      <div class="board">
        <div class="prompt" id="question-text">é¢˜ç›®åŠ è½½ä¸­â€¦â€¦</div>
        <div class="scene" id="scene"></div>
        <div class="tip-text" id="tip-text">
          å°æç¤ºï¼šå¯ä»¥ä¸€è¾¹ç”¨æ‰‹æŒ‡ç‚¹ä¸€è¾¹æ•°ï¼Œåˆ«è·³è¿‡ï¼Œä¹Ÿåˆ«é‡å¤æ•°å“¦ã€‚
        </div>
      </div>

      <div class="prompt">è¯·é€‰æ‹©ä½ è®¤ä¸ºæ­£ç¡®çš„ç­”æ¡ˆï¼š</div>
      <div class="num-grid" id="options-grid"></div>

      <div class="feedback" id="feedback"></div>

      <div class="controls">
        <button class="btn btn-ghost" id="btn-help">ğŸ“š çœ‹æç¤º</button>
        <div style="display:flex; gap:8px;">
          <button class="btn btn-ghost" id="btn-restart">ğŸ” é‡ç½®æœ¬ç­‰çº§è¿›åº¦</button>
          <button class="btn btn-main" id="btn-next" disabled>ä¸‹ä¸€é¢˜ â–¶</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ======= çŠ¶æ€å˜é‡ =======
    const levels = [
      {
        id: 1,
        name: "Lv.1 ç®€å• Â· æ•°ä¸€æ•° 0ï½5",
        tip: "æœ¬ç­‰çº§ä¸»è¦ç»ƒä¹  0ï½5 çš„æ•°æ•°å’Œçœ‹å›¾æ•°ä¸€æ•°ã€‚",
      },
      {
        id: 2,
        name: "Lv.2 ä¸­ç­‰ Â· 0ï½10 å’Œç¬¬å‡ ä¸ª",
        tip: "æ³¨æ„åŒºåˆ†â€œæœ‰å‡ ä¸ªâ€å’Œâ€œç¬¬å‡ ä¸ªâ€ï¼šæœ‰å‡ ä¸ªæ˜¯æ•°æ€»æ•°ï¼Œç¬¬å‡ ä¸ªæ˜¯ä»å·¦å¾€å³æ•°çš„ä½ç½®ã€‚",
      },
      {
        id: 3,
        name: "Lv.3 å›°éš¾ Â· åå‡ å’Œæ•°è½´è·³ä¸€è·³",
        tip: "è®°ä½ï¼šåå‡  = 1 ä¸ªåå†åŠ å‡ ä¸ªä¸€ï¼›æ•°è½´ä¸Šå¾€å‰è·³å‡ æ­¥å°±ç›¸å½“äºåŠ å‡ ã€‚",
      }
    ];

    let currentLevelIndex = 0;   // 0,1,2
    let correctInLevel = 0;
    let levelCleared = [false, false, false];
    let totalScore = 0;

    let currentQuestion = null;  // { type, text, correct, options, explain }
    let answered = false;

    // æŒ‘æˆ˜æ¨¡å¼
    let challengeUnlocked = false;
    let challengeActive = false;
    let challengeScore = 0;
    let challengeTimeLeft = 0;
    let challengeTimerId = null;

    // ======= DOM å¼•ç”¨ =======
    const levelLabelEl = document.getElementById("level-label");
    const levelProgressEl = document.getElementById("level-progress");
    const totalScoreEl = document.getElementById("total-score");
    const questionTextEl = document.getElementById("question-text");
    const sceneEl = document.getElementById("scene");
    const tipTextEl = document.getElementById("tip-text");
    const optionsGridEl = document.getElementById("options-grid");
    const feedbackEl = document.getElementById("feedback");

    const btnHelp = document.getElementById("btn-help");
    const btnRestart = document.getElementById("btn-restart");
    const btnNext = document.getElementById("btn-next");

    const diffButtons = [
      document.getElementById("btn-level-0"),
      document.getElementById("btn-level-1"),
      document.getElementById("btn-level-2"),
    ];

    const btnChallenge = document.getElementById("btn-challenge");
    const challengeStatusEl = document.getElementById("challenge-status");
    const leaderboardEl = document.getElementById("leaderboard");

    // ======= å·¥å…·å‡½æ•° =======
    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function shuffle(arr) {
      return arr.sort(() => Math.random() - 0.5);
    }

    // ======= å‡ºé¢˜é€»è¾‘ =======
    function newQuestion() {
      answered = false;
      feedbackEl.textContent = "";
      feedbackEl.className = "feedback";
      btnNext.disabled = true;
      sceneEl.innerHTML = "";
      optionsGridEl.innerHTML = "";

      const lv = currentLevelIndex;

      let q;
      if (lv === 0) {
        // ç®€å•ï¼šä»¥æ•°æ˜Ÿæ˜Ÿä¸ºä¸»ï¼ˆ0ï½5ï¼‰ï¼Œæœ‰æ—¶ç”¨ 0ï½10
        const types = ["count"];
        const t = types[randInt(0, types.length - 1)];
        if (t === "count") {
          q = makeCountQuestion(lv);
        }
      } else if (lv === 1) {
        // ä¸­ç­‰ï¼šæ•°ä¸€æ•° + ç¬¬å‡ ä¸ª + ç®€å•æ•°è½´
        const types = ["count", "ordinal", "line"];
        const t = types[randInt(0, types.length - 1)];
        if (t === "count") q = makeCountQuestion(lv);
        else if (t === "ordinal") q = makeOrdinalQuestion();
        else q = makeNumberLineQuestion(lv);
      } else {
        // å›°éš¾ï¼šæ•°ä¸€æ•° + æ•°è½´ + åå‡ 
        const types = ["count", "line", "teen"];
        const t = types[randInt(0, types.length - 1)];
        if (t === "count") q = makeCountQuestion(lv);
        else if (t === "line") q = makeNumberLineQuestion(lv);
        else q = makeTeenQuestion();
      }

      currentQuestion = q;

      questionTextEl.textContent = "é¢˜ç›®ï¼š" + q.text;
      renderScene(q);

      // æŒ‘æˆ˜æ¨¡å¼ä¸‹ä¸æ˜¾ç¤ºæç¤ºæ–‡å­—
      if (challengeActive) {
        tipTextEl.style.display = "none";
      } else {
        tipTextEl.style.display = "block";
        tipTextEl.textContent = q.tipShort || levels[currentLevelIndex].tip;
      }

      buildOptions(q);
    }

    // â€”â€” é¢˜å‹ä¸€ï¼šæ•°ä¸€æ•°å°æ˜Ÿæ˜Ÿ â€”â€”
    function makeCountQuestion(levelIndex) {
      let n;
      if (levelIndex === 0) {
        n = randInt(0, 5);
      } else if (levelIndex === 1) {
        n = randInt(2, 10);
      } else {
        n = randInt(5, 12);
      }

      const text = "è¯·æ•°ä¸€æ•°ï¼Œè¿™é‡Œä¸€å…±æœ‰å¤šå°‘ä¸ªå°æ˜Ÿæ˜Ÿï¼Ÿ";
      const explain =
        `ä½ å¯ä»¥ç”¨æ‰‹æŒ‡ä»å·¦åˆ°å³ï¼Œä¸€ä¸ªä¸€ä¸ªç‚¹ç€æ•°ï¼š1ã€2ã€3â€¦â€¦æ•°åˆ°æœ€åä¸€ä¸ªã€‚\n` +
        `æ•°åˆ°çš„æœ€åä¸€ä¸ªæ•°å°±æ˜¯ä¸€å…±æœ‰å¤šå°‘ä¸ªã€‚è¿™é‡Œæ•°å‡ºæ¥æ˜¯ ${n} ä¸ªã€‚`;

      return {
        type: "count",
        text,
        correct: n,
        explain,
        count: n,
        tipShort: "æ•°çš„æ—¶å€™ä¸è¦è·³è¿‡ï¼Œä¹Ÿä¸è¦ä¸€ä¸ªæ˜Ÿæ˜Ÿæ•°ä¸¤æ¬¡ã€‚",
      };
    }

    // â€”â€” é¢˜å‹äºŒï¼šç¬¬å‡ ä¸ªï¼ˆå½©è‰²å°çƒï¼‰ â€”â€”
    function makeOrdinalQuestion() {
      const colors = [
        { name: "çº¢è‰²", css: "#f97373" },
        { name: "è“è‰²", css: "#38bdf8" },
        { name: "ç»¿è‰²", css: "#4ade80" },
        { name: "é»„è‰²", css: "#facc15" },
        { name: "ç´«è‰²", css: "#a855f7" },
        { name: "æ©™è‰²", css: "#fb923c" },
      ];

      const len = randInt(4, 7);
      const balls = [];
      for (let i = 0; i < len; i++) {
        balls.push(colors[randInt(0, colors.length - 1)]);
      }
      const which = randInt(1, len);
      const correctColor = balls[which - 1];

      const text = `ä»å·¦å¾€å³æ•°ï¼Œç¬¬ ${which} ä¸ªå°çƒæ˜¯ä»€ä¹ˆé¢œè‰²ï¼Ÿ`;
      const explain =
        `â€œç¬¬å‡ ä¸ªâ€ä¸€å®šè¦ä»å·¦è¾¹ç¬¬ä¸€ä¸ªå¼€å§‹æ•°ï¼šç¬¬ 1 ä¸ªã€ç¬¬ 2 ä¸ªã€ç¬¬ 3 ä¸ªâ€¦â€¦\n` +
        `ä½ æ•°åˆ°ç¬¬ ${which} ä¸ªæ—¶ï¼Œçœ‹åˆ°çš„æ˜¯ ${correctColor.name} çš„å°çƒï¼Œæ‰€ä»¥ç­”æ¡ˆæ˜¯â€œ${correctColor.name}â€ã€‚`;

      return {
        type: "ordinal",
        text,
        correct: correctColor.name,
        explain,
        balls,
        which,
        tipShort: "è®°å¾—ä»å·¦è¾¹ç¬¬ 1 ä¸ªå¼€å§‹æ•°ï¼Œä¸è¦ä»ä¸­é—´å¼€å§‹æ•°å“¦ã€‚",
      };
    }

    // â€”â€” é¢˜å‹ä¸‰ï¼šæ•°è½´è·³ä¸€è·³ â€”â€”
    function makeNumberLineQuestion(levelIndex) {
      let start, steps, maxEnd;
      if (levelIndex === 1) {
        start = randInt(0, 5);
        steps = randInt(1, 4);
        maxEnd = 10;
      } else {
        start = randInt(0, 9);
        steps = randInt(1, 5);
        maxEnd = 15;
      }
      let end = start + steps;
      if (end > maxEnd) {
        end = maxEnd;
        steps = end - start;
      }
      const text = `å°é’è›™åœ¨æ•°è½´ä¸Šçš„ ${start} è¿™é‡Œï¼Œå‘å³è·³ ${steps} æ ¼ï¼Œä¼šè·³åˆ°å‡ ï¼Ÿ`;
      const explain =
        `åœ¨æ•°è½´ä¸Šå‘å³è·³ ${steps} æ ¼ï¼Œå°±ç›¸å½“äºåœ¨ ${start} çš„åŸºç¡€ä¸ŠåŠ  ${steps}ã€‚\n` +
        `${start} + ${steps} = ${end}ï¼Œæ‰€ä»¥æœ€åä¼šåœåœ¨ ${end}ã€‚`;

      return {
        type: "line",
        text,
        correct: end,
        explain,
        start,
        steps,
        max: maxEnd,
        tipShort: "æ¯è·³ä¸€æ ¼ï¼Œå°±æ˜¯åŠ  1ï¼›è·³å‡ æ ¼å°±æ˜¯åŠ å‡ ã€‚",
      };
    }

    // â€”â€” é¢˜å‹å››ï¼šåå‡ ï¼ˆ1 ä¸ªå + å‡ ä¸ªä¸€ï¼‰ â€”â€”
    function makeTeenQuestion() {
      const ones = randInt(1, 9);
      const total = 10 + ones;
      const text = `1 ä¸ªâ€œåâ€å’Œ ${ones} ä¸ªâ€œä¸€â€åˆèµ·æ¥æ˜¯å¤šå°‘ï¼Ÿ`;
      const explain =
        `1 ä¸ªâ€œåâ€å°±æ˜¯ 10ï¼Œå†åŠ ä¸Š ${ones} ä¸ªâ€œä¸€â€ï¼š\n` +
        `10 + ${ones} = ${total}ã€‚\n` +
        `æ‰€ä»¥æ˜¯ ${total}ã€‚è¿™å°±æ˜¯â€œåå‡ â€çš„æ„æ€ï¼š1 ä¸ªåå†åŠ å‡ ä¸ªä¸€ã€‚`;

      return {
        type: "teen",
        text,
        correct: total,
        explain,
        ones,
        tipShort: "å…ˆæƒ³ 1 ä¸ªâ€œåâ€å°±æ˜¯ 10ï¼Œå†æŠŠåé¢çš„â€œä¸€â€åŠ ä¸Šå»ã€‚",
      };
    }

    // ======= åœºæ™¯æ¸²æŸ“ =======
    function renderScene(q) {
      sceneEl.innerHTML = "";

      if (q.type === "count") {
        const grid = document.createElement("div");
        grid.className = "star-grid";
        for (let i = 0; i < q.count; i++) {
          const star = document.createElement("div");
          star.className = "star";
          grid.appendChild(star);
        }
        sceneEl.appendChild(grid);
        if (q.count === 0) {
          const txt = document.createElement("div");
          txt.style.textAlign = "center";
          txt.style.fontSize = "13px";
          txt.style.color = "#9ca3af";
          txt.textContent = "è¿™é‡Œä¸€ä¸ªæ˜Ÿæ˜Ÿä¹Ÿæ²¡æœ‰ï¼Œè¿™å°±æ˜¯ 0 ä¸ªã€‚";
          sceneEl.appendChild(txt);
        }
      } else if (q.type === "ordinal") {
        const row = document.createElement("div");
        row.className = "ball-row";
        q.balls.forEach((b, idx) => {
          const ball = document.createElement("div");
          ball.className = "ball";
          ball.style.background = b.css;
          ball.title = `ç¬¬ ${idx + 1} ä¸ªï¼š${b.name}`;
          row.appendChild(ball);
        });
        sceneEl.appendChild(row);
      } else if (q.type === "line") {
        const line = document.createElement("div");
        line.className = "number-line";
        const max = Math.max(q.max, q.start + q.steps, 10);

        for (let i = 0; i <= max; i++) {
          const tick = document.createElement("div");
          tick.className = "number-tick";
          if (i === q.start) tick.classList.add("start");
          const span = document.createElement("span");
          span.textContent = i;
          tick.appendChild(span);
          line.appendChild(tick);
        }
        sceneEl.appendChild(line);

        const base = document.createElement("div");
        base.className = "number-line-base";
        sceneEl.appendChild(base);
      } else if (q.type === "teen") {
        const wrap = document.createElement("div");
        wrap.className = "teen-train";

        const tenBlock = document.createElement("div");
        tenBlock.className = "ten-block";
        const tenTitle = document.createElement("div");
        tenTitle.className = "ten-block-title";
        tenTitle.textContent = "1 ä¸ªå (=10)";
        tenBlock.appendChild(tenTitle);
        const tenGrid = document.createElement("div");
        tenGrid.className = "ten-grid";
        for (let i = 0; i < 10; i++) {
          const cell = document.createElement("div");
          cell.className = "ten-cell";
          tenGrid.appendChild(cell);
        }
        tenBlock.appendChild(tenGrid);

        const oneBlock = document.createElement("div");
        oneBlock.className = "one-block";
        const oneTitle = document.createElement("div");
        oneTitle.className = "one-block-title";
        oneTitle.textContent = `${q.ones} ä¸ªä¸€`;
        oneBlock.appendChild(oneTitle);
        const row = document.createElement("div");
        row.className = "ones-row";
        for (let i = 0; i < q.ones; i++) {
          const dot = document.createElement("div");
          dot.className = "one-dot";
          row.appendChild(dot);
        }
        oneBlock.appendChild(row);

        wrap.appendChild(tenBlock);
        wrap.appendChild(oneBlock);

        sceneEl.appendChild(wrap);
      }
    }

    // ======= é€‰é¡¹æ„å»º =======
    function buildOptions(q) {
      optionsGridEl.innerHTML = "";

      let optionValues = new Set();
      if (q.type === "ordinal") {
        // é¢œè‰²é€‰é¡¹
        optionValues.add(q.correct);
        const colorPool = ["çº¢è‰²","è“è‰²","ç»¿è‰²","é»„è‰²","ç´«è‰²","æ©™è‰²"];
        while (optionValues.size < 4) {
          const c = colorPool[randInt(0, colorPool.length - 1)];
          optionValues.add(c);
        }
      } else {
        // æ•°å­—é€‰é¡¹
        optionValues.add(q.correct);
        while (optionValues.size < 4) {
          let delta = randInt(-3, 3);
          if (delta === 0) continue;
          let candidate = q.correct + delta;
          if (candidate < 0 || candidate > 30) continue;
          optionValues.add(candidate);
        }
      }

      shuffle(Array.from(optionValues)).forEach(val => {
        const btn = document.createElement("button");
        btn.className = "num-btn";

        if (q.type === "ordinal") {
          // æ˜¾ç¤ºé¢œè‰²å + å°è‰²å—
          btn.textContent = "";
          const colorText = document.createElement("span");
          colorText.textContent = val;
          const colorDot = document.createElement("span");
          colorDot.style.display = "inline-block";
          colorDot.style.width = "14px";
          colorDot.style.height = "14px";
          colorDot.style.borderRadius = "50%";
          colorDot.style.marginRight = "6px";
          colorDot.style.border = "1px solid #111827";

          const colorMap = {
            "çº¢è‰²": "#f97373",
            "è“è‰²": "#38bdf8",
            "ç»¿è‰²": "#4ade80",
            "é»„è‰²": "#facc15",
            "ç´«è‰²": "#a855f7",
            "æ©™è‰²": "#fb923c",
          };
          colorDot.style.background = colorMap[val] || "#e5e7eb";

          btn.appendChild(colorDot);
          btn.appendChild(colorText);
        } else {
          btn.textContent = val;
        }

        btn.addEventListener("click", () => handleAnswer(val, btn));
        optionsGridEl.appendChild(btn);
      });
    }

    // ======= åˆ¤é¢˜é€»è¾‘ =======
    function handleAnswer(value, btn) {
      if (answered) return;
      answered = true;

      const q = currentQuestion;
      const isCorrect = value === q.correct;

      optionsGridEl.querySelectorAll(".num-btn").forEach(b => (b.disabled = true));

      if (isCorrect) {
        btn.classList.add("correct");
        feedbackEl.className = "feedback ok";
        if (challengeActive) {
          challengeScore += 1;
          feedbackEl.textContent =
            `âœ… å¤ªæ£’äº†ï¼ä½ åœ¨æŒ‘æˆ˜æ¨¡å¼ä¸­åˆç­”å¯¹äº†ä¸€é¢˜ï¼Œç›®å‰æ€»å…±ç­”å¯¹ ${challengeScore} é¢˜ã€‚`;
          challengeStatusEl.textContent =
            `æŒ‘æˆ˜æ¨¡å¼è¿›è¡Œä¸­ï¼šå‰©ä½™ ${challengeTimeLeft} ç§’ï¼Œå·²ç­”å¯¹ ${challengeScore} é¢˜ã€‚`;
        } else {
          feedbackEl.textContent = `âœ… å›ç­”æ­£ç¡®ï¼\n` + q.explain;
          correctInLevel += 1;
          totalScore += 10;
          totalScoreEl.textContent = totalScore;
          levelProgressEl.textContent = `${correctInLevel} / 5`;

          if (correctInLevel >= 5 && !levelCleared[currentLevelIndex]) {
            levelCleared[currentLevelIndex] = true;
            updateDiffButtons();
            feedbackEl.textContent +=
              `\nğŸ‰ ä½ å·²ç»å®Œæˆâ€œ${levels[currentLevelIndex].name}â€çš„ 5 é¢˜æŒ‘æˆ˜ï¼Œå¯ä»¥ç»§ç»­ç»ƒä¹ æˆ–åˆ‡æ¢ç­‰çº§ã€‚`;
            if (levelCleared.every(v => v)) {
              unlockChallenge();
            }
          }
        }
      } else {
        btn.classList.add("wrong");
        feedbackEl.className = "feedback bad";
        if (!challengeActive) {
          let extra = "";
          if (q.type === "count") {
            extra = "å¯ä»¥é‡æ–°ç”¨æ‰‹æŒ‡ä¸€ä¸ªä¸€ä¸ªç‚¹ç€æ•°ï¼Œå†æƒ³æƒ³ã€‚";
          } else if (q.type === "ordinal") {
            extra = "ä½ å¯èƒ½æ•°é”™ç¬¬å‡ ä¸ªäº†ï¼Œè®°å¾—ä»å·¦è¾¹ç¬¬ 1 ä¸ªå¼€å§‹æ•°ã€‚";
          } else if (q.type === "line") {
            extra = "æ¯è·³ä¸€æ ¼å°±æ˜¯åŠ  1ï¼Œä½ å¯ä»¥åœ¨å¿ƒé‡Œè·Ÿç€æ•°ï¼šåŠ  1ã€åŠ  2ã€åŠ  3â€¦â€¦";
          } else if (q.type === "teen") {
            extra = "å…ˆæŠŠ 1 ä¸ªåå½“æˆ 10ï¼Œå†æŠŠå‡ ä¸ªä¸€åŠ ä¸Šå»ï¼Œä¼šæ›´æ¸…æ¥šã€‚";
          }
          feedbackEl.textContent =
            `âŒ è¿™æ¬¡æ²¡æœ‰åšå¯¹ï¼Œæ²¡å…³ç³»ï¼Œæˆ‘ä»¬çœ‹çœ‹æ­£ç¡®æƒ³æ³•ï¼š\n` +
            q.explain + `\n\nå°å»ºè®®ï¼š${extra}`;
        } else {
          feedbackEl.textContent =
            `âŒ è¿™é¢˜æ²¡å¯¹ï¼ŒæŒ‘æˆ˜æ¨¡å¼ä¸‹ä¸å±•å¼€è§£é‡Šï¼Œé å¹³æ—¶ç»ƒä¹ çš„æœ¬é¢†ç»§ç»­å†²ä¸‹ä¸€é¢˜ï¼`;
        }
      }

      btnNext.disabled = false;

      if (challengeActive) {
        setTimeout(() => {
          newQuestion();
        }, 350);
      }
    }

    // ======= éš¾åº¦ UI =======
    function updateLevelUI() {
      const lv = levels[currentLevelIndex];
      levelLabelEl.textContent = lv.name;
      levelProgressEl.textContent = `${correctInLevel} / 5`;
      if (!challengeActive) {
        tipTextEl.style.display = "block";
        tipTextEl.textContent = lv.tip;
      }
    }

    function updateDiffButtons() {
      diffButtons.forEach((btn, idx) => {
        btn.classList.toggle("active", idx === currentLevelIndex);
        if (levelCleared[idx]) btn.classList.add("cleared");
        else btn.classList.remove("cleared");
      });
    }

    diffButtons.forEach((btn, idx) => {
      btn.addEventListener("click", () => {
        if (challengeActive) return;
        currentLevelIndex = idx;
        correctInLevel = 0;
        updateDiffButtons();
        updateLevelUI();
        feedbackEl.textContent = "";
        feedbackEl.className = "feedback";
        newQuestion();
      });
    });

    btnNext.addEventListener("click", () => {
      if (challengeActive) return;
      newQuestion();
    });

    btnRestart.addEventListener("click", () => {
      if (challengeActive) return;
      correctInLevel = 0;
      updateLevelUI();
      feedbackEl.textContent = "";
      feedbackEl.className = "feedback";
      newQuestion();
    });

    btnHelp.addEventListener("click", () => {
      if (challengeActive) return;
      const lv = levels[currentLevelIndex];
      feedbackEl.className = "feedback";
      feedbackEl.textContent =
        `ğŸ” å°æç¤ºï¼š${lv.tip}\nå¦‚æœæ˜¯æ•°ä¸€æ•°ï¼Œå¯ä»¥è¾¹ç‚¹è¾¹æ•°ï¼›å¦‚æœæ˜¯â€œç¬¬å‡ ä¸ªâ€ï¼Œä¸€å®šè¦ä»å·¦è¾¹ç¬¬ 1 ä¸ªå¼€å§‹æ•°ã€‚`;
    });

    // ======= æ’è¡Œæ¦œ & æŒ‘æˆ˜æ¨¡å¼ =======
    function getLeaderboard() {
      try {
        const raw = localStorage.getItem("g1_world1_leaderboard");
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function saveLeaderboard(list) {
      try {
        localStorage.setItem("g1_world1_leaderboard", JSON.stringify(list));
      } catch {}
    }

    function renderLeaderboard() {
      const list = getLeaderboard();
      if (!list.length) {
        leaderboardEl.textContent = "æŒ‘æˆ˜æ’è¡Œæ¦œï¼šè¿˜æ²¡æœ‰è®°å½•ï¼Œå¿«æ¥æˆä¸ºç¬¬ä¸€ä¸ªå§ï¼";
        return;
      }
      let html = "<strong>æŒ‘æˆ˜æ’è¡Œæ¦œï¼ˆ60 ç§’å†…ç­”å¯¹é¢˜æ•°ï¼‰ï¼š</strong><br>";
      list.forEach((item, idx) => {
        const d = new Date(item.time);
        const label =
          `${d.getMonth() + 1}/${d.getDate()} ` +
          `${String(d.getHours()).padStart(2, "0")}:${String(d.getMinutes()).padStart(2, "0")}`;
        html += `${idx + 1}. ${item.score} é¢˜ï¼ˆ${label}ï¼‰<br>`;
      });
      leaderboardEl.innerHTML = html;
    }

    function updateLeaderboard(score) {
      let list = getLeaderboard();
      list.push({ score, time: Date.now() });
      list.sort((a, b) => {
        if (b.score !== a.score) return b.score - a.score;
        return a.time - b.time;
      });
      list = list.slice(0, 5);
      saveLeaderboard(list);
      renderLeaderboard();
    }

    function unlockChallenge() {
      if (challengeUnlocked) return;
      challengeUnlocked = true;
      try {
        localStorage.setItem("g1_world1_challenge_unlocked", "1");
      } catch {}
      btnChallenge.disabled = false;
      btnChallenge.textContent = "ğŸ”¥ æŒ‘æˆ˜æ¨¡å¼ï¼š1 åˆ†é’Ÿæ•°æ•°å¤§è€ƒéªŒï¼ˆå·²è§£é”ï¼Œç‚¹å‡»å¼€å§‹ï¼‰";
      challengeStatusEl.textContent =
        "æŒ‘æˆ˜æ¨¡å¼å·²è§£é”ï¼š60 ç§’å†…çœ‹ä½ èƒ½åšå¯¹å¤šå°‘é“é¢˜ï¼é¢˜ç›®ä¼šåŒ…å«æ•°æ•°ã€æ•°è½´å’Œâ€œåå‡ â€çš„é—®é¢˜ã€‚";
    }

    function loadChallengeUnlock() {
      try {
        const flag = localStorage.getItem("g1_world1_challenge_unlocked");
        if (flag === "1") {
          challengeUnlocked = true;
          btnChallenge.disabled = false;
          btnChallenge.textContent = "ğŸ”¥ æŒ‘æˆ˜æ¨¡å¼ï¼š1 åˆ†é’Ÿæ•°æ•°å¤§è€ƒéªŒï¼ˆå·²è§£é”ï¼Œç‚¹å‡»å¼€å§‹ï¼‰";
          challengeStatusEl.textContent =
            "æŒ‘æˆ˜æ¨¡å¼å·²è§£é”ï¼š60 ç§’å†…çœ‹ä½ èƒ½åšå¯¹å¤šå°‘é“é¢˜ï¼é¢˜ç›®ä¼šåŒ…å«æ•°æ•°ã€æ•°è½´å’Œâ€œåå‡ â€çš„é—®é¢˜ã€‚";
        }
      } catch {}
    }

    function startChallenge() {
      if (!challengeUnlocked || challengeActive) return;
      challengeActive = true;
      challengeScore = 0;
      challengeTimeLeft = 60;

      currentLevelIndex = 2; // ç”¨å›°éš¾ç­‰çº§é¢˜å‹
      correctInLevel = 0;
      updateDiffButtons();

      levelLabelEl.textContent = "æŒ‘æˆ˜æ¨¡å¼ï¼š1 åˆ†é’Ÿæ•°æ•°å¤§è€ƒéªŒ";
      levelProgressEl.textContent = "-";
      feedbackEl.textContent = "";
      feedbackEl.className = "feedback";

      btnRestart.disabled = true;
      btnHelp.disabled = true;
      btnNext.disabled = true;

      tipTextEl.style.display = "none";

      challengeStatusEl.textContent =
        `æŒ‘æˆ˜æ¨¡å¼è¿›è¡Œä¸­ï¼šå‰©ä½™ ${challengeTimeLeft} ç§’ï¼Œå·²ç­”å¯¹ 0 é¢˜ã€‚`;

      if (challengeTimerId) clearInterval(challengeTimerId);
      challengeTimerId = setInterval(() => {
        challengeTimeLeft--;
        if (challengeTimeLeft <= 0) {
          endChallenge();
        } else {
          challengeStatusEl.textContent =
            `æŒ‘æˆ˜æ¨¡å¼è¿›è¡Œä¸­ï¼šå‰©ä½™ ${challengeTimeLeft} ç§’ï¼Œå·²ç­”å¯¹ ${challengeScore} é¢˜ã€‚`;
        }
      }, 1000);

      newQuestion();
    }

    function endChallenge() {
      if (!challengeActive) return;
      challengeActive = false;
      clearInterval(challengeTimerId);
      challengeTimerId = null;

      challengeStatusEl.textContent =
        `æœ¬è½®ç»“æŸï¼šä½ åœ¨ 60 ç§’å†…ä¸€å…±ç­”å¯¹äº† ${challengeScore} é¢˜ï¼å¯ä»¥å†è¯•ä¸€æ¬¡æŒ‘æˆ˜ï¼Œæˆ–è€…å›åˆ°æ™®é€šæ¨¡å¼ç»§ç»­ç»ƒä¹ ã€‚`;

      btnRestart.disabled = false;
      btnHelp.disabled = false;
      btnNext.disabled = false;

      currentLevelIndex = 2;
      updateLevelUI();

      updateLeaderboard(challengeScore);
    }

    btnChallenge.addEventListener("click", () => {
      if (!challengeUnlocked) return;
      startChallenge();
    });

    // ======= åˆå§‹åŒ– =======
    function init() {
      loadChallengeUnlock();
      renderLeaderboard();
      updateDiffButtons();
      updateLevelUI();
      newQuestion();
    }

    init();
  </script>
</body>
</html>
