<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å››å¹´çº§æ•°å­¦ Â· ä¸–ç•Œä¸€ï¼šæ•°ä½å¡”æ¥¼å®ˆæŠ¤</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: radial-gradient(circle at top, #020617, #020617 40%, #000 100%);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px 10px 40px;
    }
    .container {
      width: 100%;
      max-width: 900px;
    }
    a.back {
      display: inline-block;
      margin-bottom: 8px;
      font-size: 13px;
      color: #38bdf8;
      text-decoration: none;
    }
    a.back:hover { text-decoration: underline; }

    h1 {
      margin: 4px 0;
      font-size: 24px;
    }
    .subtitle {
      font-size: 14px;
      color: #9ca3af;
      margin-bottom: 16px;
      line-height: 1.5;
    }

    .card {
      background: rgba(15,23,42,0.96);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 16px 40px rgba(15,23,42,0.9);
      border: 1px solid #1f2937;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 14px;
      color: #9ca3af;
      margin-bottom: 10px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      font-size: 12px;
      color: #cbd5f5;
    }
    .badge span.level {
      font-weight: bold;
      color: #facc15;
    }

    .difficulty-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
      font-size: 13px;
      align-items: center;
    }
    .diff-label {
      color: #9ca3af;
    }
    .diff-btn {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      padding: 4px 10px;
      font-size: 13px;
      cursor: pointer;
      transition: all .15s ease;
    }
    .diff-btn.active {
      background: #2563eb;
      border-color: #60a5fa;
      color: #fff;
    }
    .diff-btn.cleared::after {
      content: " âœ”";
      color: #4ade80;
      font-size: 11px;
    }

    .challenge-zone {
      margin-bottom: 12px;
      padding: 8px 10px;
      border-radius: 12px;
      background: #020617;
      border: 1px dashed #374151;
      font-size: 13px;
      color: #9ca3af;
    }
    .challenge-zone button {
      margin-bottom: 6px;
    }
    .challenge-status {
      margin-bottom: 4px;
    }
    .leaderboard {
      font-size: 12px;
      color: #9ca3af;
      line-height: 1.4;
    }

    .board {
      margin: 6px 0 12px;
      border-radius: 14px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 14px;
    }
    .prompt {
      font-size: 15px;
      margin-bottom: 8px;
    }
    .big-number {
      font-size: 28px;
      letter-spacing: 3px;
      text-align: center;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #020617;
      margin-bottom: 10px;
    }

    .digit-grid {
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: minmax(0, 1fr);
      gap: 4px;
      margin-top: 6px;
      overflow-x: auto;
      padding-bottom: 4px;
    }
    .digit-col {
      text-align: center;
      min-width: 46px;
    }
    .digit-value {
      font-size: 18px;
      padding: 4px 0;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      margin-bottom: 3px;
    }
    .digit-label {
      font-size: 11px;
      color: #a5b4fc;
    }
    .digit-arrow {
      font-size: 13px;
      color: #fbbf24;
      margin-top: 2px;
      line-height: 1;
    }
    .digit-col.highlight .digit-value {
      background: #1d4ed8;
      border-color: #60a5fa;
    }
    .digit-col.highlight .digit-label {
      color: #fde68a;
      font-weight: bold;
    }

    .tower-tip {
      font-size: 13px;
      color: #9ca3af;
      margin-top: 6px;
      white-space: pre-line;
    }

    .num-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin: 8px 0;
    }
    .num-btn {
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 16px;
      padding: 8px 0;
      cursor: pointer;
      transition: all .15s ease;
    }
    .num-btn:hover {
      background: #0b1120;
      border-color: #38bdf8;
    }
    .num-btn.correct {
      background: #16a34a;
      border-color: #22c55e;
      color: #e5fdf0;
    }
    .num-btn.wrong {
      background: #7f1d1d;
      border-color: #ef4444;
      color: #fee2e2;
    }

    .feedback {
      min-height: 40px;
      font-size: 14px;
      margin-top: 4px;
      line-height: 1.4;
    }
    .feedback.ok { color: #4ade80; }
    .feedback.bad { color: #fecaca; }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    .btn {
      border-radius: 999px;
      padding: 6px 16px;
      font-size: 14px;
      border: none;
      cursor: pointer;
      transition: all .15s ease;
    }
    .btn-main {
      background: #2563eb;
      color: #fff;
    }
    .btn-main:disabled {
      background: #1f2937;
      color: #6b7280;
      cursor: not-allowed;
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid #4b5563;
      color: #9ca3af;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    @media (max-width: 640px) {
      .big-number { font-size: 24px; }
      .num-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="math.html" class="back">âª è¿”å›æ•°å­¦å­¦ä¹ ä¸­å¿ƒ</a>

    <h1>å››å¹´çº§æ•°å­¦ Â· ä¸–ç•Œä¸€ï¼šæ•°ä½å¡”æ¥¼å®ˆæŠ¤</h1>
    <div class="subtitle">
      å°å°å®ˆæŠ¤è€…ï¼Œä½ è¦ä¿æŠ¤<strong>å¤§æ•°å¡”æ¥¼</strong>ä¸è¢«æ•°å­—æ€ªç‰©æ”»å ã€‚<br/>
      æ¯ä¸€å…³ä¼šå‡ºç°ä¸€ä¸ªå¤§æ•°ï¼Œè¯·ä½ çœ‹æ¸…æ¥šæ•°ä½ï¼Œå›ç­”å…³äºâ€œä¸‡ã€åä¸‡ã€ç™¾ä¸‡ã€åƒä¸‡ã€äº¿â€çš„é—®é¢˜ã€‚<br/>
      ä½ å¯ä»¥è‡ªå·±é€‰æ‹©<strong>ç®€å• / ä¸­ç­‰ / å›°éš¾</strong>ç­‰çº§ï¼Œä¸‰ä¸ªç­‰çº§éƒ½å®Œæˆåï¼Œä¼šè§£é”<strong>1 åˆ†é’ŸæŒ‘æˆ˜æ¨¡å¼</strong>ã€‚
    </div>

    <div class="card">
      <div class="top-bar">
        <div class="badge">
          å½“å‰æ¨¡å¼ï¼š
          <span class="level" id="level-label">Lv.1 ç®€å• Â· ä¸‡ä»¥å†…</span>
        </div>
        <div class="badge">
          æœ¬ç­‰çº§è¿›åº¦ï¼š<span id="level-progress">0 / 5</span>
        </div>
        <div class="badge">
          æ€»å¾—åˆ†ï¼š<span id="total-score">0</span>
        </div>
      </div>

      <!-- ç­‰çº§é€‰æ‹©ï¼ˆå­©å­å¯è‡ªç”±åˆ‡æ¢ï¼‰ -->
      <div class="difficulty-row">
        <span class="diff-label">é€‰æ‹©ç­‰çº§ï¼ˆå»ºè®®å…ˆä»ç®€å•å¼€å§‹ï¼‰ï¼š</span>
        <button class="diff-btn active" data-level="0" id="btn-level-0">ç®€å•</button>
        <button class="diff-btn" data-level="1" id="btn-level-1">ä¸­ç­‰</button>
        <button class="diff-btn" data-level="2" id="btn-level-2">å›°éš¾</button>
      </div>

      <!-- æŒ‘æˆ˜æ¨¡å¼åŒºåŸŸ -->
      <div class="challenge-zone">
        <button class="btn btn-ghost" id="btn-challenge" disabled>
          ğŸ”’ æŒ‘æˆ˜æ¨¡å¼ï¼šå®Œæˆä¸‰ä¸ªç­‰çº§åè§£é”
        </button>
        <div class="challenge-status" id="challenge-status">
          å®Œæˆç®€å•ã€ä¸­ç­‰ã€å›°éš¾ä¸‰ä¸ªç­‰çº§å„ 5 é¢˜åï¼Œå°±å¯ä»¥å¼€å¯ 60 ç§’æŒ‘æˆ˜ã€‚
        </div>
        <div class="leaderboard" id="leaderboard">
          æŒ‘æˆ˜æ’è¡Œæ¦œï¼šè¿˜æ²¡æœ‰è®°å½•ï¼Œç­‰ä½ æ¥æŒ‘æˆ˜ï¼
        </div>
      </div>

      <div class="board">
        <div class="prompt" id="question-text">
          é¢˜ç›®åŠ è½½ä¸­â€¦â€¦
        </div>
        <div class="big-number" id="big-number">00000</div>

        <div class="digit-grid" id="digit-grid">
          <!-- JS ç”Ÿæˆ -->
        </div>
        <div class="tower-tip" id="tower-tip">
          æ•°ä½ä»å³å¾€å·¦ä¾æ¬¡æ˜¯ï¼šä¸ªã€åã€ç™¾ã€åƒã€ä¸‡ã€åä¸‡ã€ç™¾ä¸‡ã€åƒä¸‡ã€äº¿â€¦â€¦
        </div>
      </div>

      <div class="prompt">è¯·é€‰æ‹©ä½ è®¤ä¸ºæ­£ç¡®çš„ç­”æ¡ˆï¼š</div>
      <div class="num-grid" id="options-grid">
        <!-- é€‰é¡¹æŒ‰é’® -->
      </div>

      <div class="feedback" id="feedback"></div>

      <div class="controls">
        <button class="btn btn-ghost" id="btn-help">ğŸ“š çœ‹æç¤º</button>
        <div style="display:flex; gap:8px;">
          <button class="btn btn-ghost" id="btn-restart">ğŸ” é‡ç½®æœ¬ç­‰çº§è¿›åº¦</button>
          <button class="btn btn-main" id="btn-next" disabled>ä¸‹ä¸€é¢˜ â–¶</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== æ•°æ®ä¸çŠ¶æ€ =====
    const placeNames = ["ä¸ª","å","ç™¾","åƒ","ä¸‡","åä¸‡","ç™¾ä¸‡","åƒä¸‡","äº¿","åäº¿","ç™¾äº¿"];
    const placeExplain = "æ•°ä½ä»å³å¾€å·¦ä¾æ¬¡æ˜¯ï¼šä¸ªã€åã€ç™¾ã€åƒã€ä¸‡ã€åä¸‡ã€ç™¾ä¸‡ã€åƒä¸‡ã€äº¿â€¦â€¦";

    const levels = [
      {
        id: 1,
        name: "Lv.1 ç®€å• Â· ä¸‡ä»¥å†…",
        minDigits: 4,
        maxDigits: 5,
        placeRange: ["ä¸ª","å","ç™¾","åƒ","ä¸‡"],
        tip: "æœ¬ç­‰çº§å…ˆç†Ÿæ‚‰ä¸‡ä»¥å†…ï¼šä¸ªã€åã€ç™¾ã€åƒã€ä¸‡ã€‚"
      },
      {
        id: 2,
        name: "Lv.2 ä¸­ç­‰ Â· ç™¾ä¸‡ä»¥å†…",
        minDigits: 5,
        maxDigits: 7,
        placeRange: ["ä¸ª","å","ç™¾","åƒ","ä¸‡","åä¸‡","ç™¾ä¸‡"],
        tip: "åŠ å…¥åä¸‡ã€ç™¾ä¸‡ï¼šè®°ä½â€œä¸‡â€å·¦è¾¹ä¸€ä½æ˜¯â€œåä¸‡â€ã€‚"
      },
      {
        id: 3,
        name: "Lv.3 å›°éš¾ Â· äº¿ä»¥å†…",
        minDigits: 7,
        maxDigits: 9,
        placeRange: ["ä¸ª","å","ç™¾","åƒ","ä¸‡","åä¸‡","ç™¾ä¸‡","åƒä¸‡","äº¿"],
        tip: "æŒæ¡åˆ°â€œäº¿â€ï¼šä¸‡çš„ä¸‡å€æ˜¯äº¿ã€‚"
      }
    ];

    let currentLevelIndex = 0;          // 0,1,2
    let correctInLevel = 0;             // å½“å‰ç­‰çº§å·²ç­”å¯¹é¢˜æ•°
    let levelCleared = [false,false,false]; // æ˜¯å¦å®Œæˆå„ç­‰çº§ï¼ˆ>=5 é¢˜ï¼‰
    let totalScore = 0;

    let currentNumber = 0;
    let currentQuestion = null;
    let answered = false;

    // æŒ‘æˆ˜æ¨¡å¼
    let challengeUnlocked = false;
    let challengeActive = false;
    let challengeScore = 0;
    let challengeTimeLeft = 0;
    let challengeTimerId = null;

    // ===== DOM å¼•ç”¨ =====
    const levelLabelEl = document.getElementById("level-label");
    const levelProgressEl = document.getElementById("level-progress");
    const totalScoreEl = document.getElementById("total-score");
    const bigNumberEl = document.getElementById("big-number");
    const digitGridEl = document.getElementById("digit-grid");
    const questionTextEl = document.getElementById("question-text");
    const optionsGridEl = document.getElementById("options-grid");
    const feedbackEl = document.getElementById("feedback");
    const towerTipEl = document.getElementById("tower-tip");

    const btnNext = document.getElementById("btn-next");
    const btnRestart = document.getElementById("btn-restart");
    const btnHelp = document.getElementById("btn-help");

    const btnChallenge = document.getElementById("btn-challenge");
    const challengeStatusEl = document.getElementById("challenge-status");
    const leaderboardEl = document.getElementById("leaderboard");

    const diffButtons = [
      document.getElementById("btn-level-0"),
      document.getElementById("btn-level-1"),
      document.getElementById("btn-level-2")
    ];

    // ===== å·¥å…·å‡½æ•° =====
    function shuffle(arr) {
      return arr.sort(() => Math.random() - 0.5);
    }

    function placeIndexFromRight(placeName) {
      return placeNames.indexOf(placeName); // 0=ä¸ª,1=å,...
    }

    function randomIntegerWithDigits(minDigits, maxDigits) {
      const digits = Math.floor(Math.random() * (maxDigits - minDigits + 1)) + minDigits;
      const min = Math.pow(10, digits - 1);
      const max = Math.pow(10, digits) - 1;
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function splitNumber(num) {
      return String(num).split("").map(ch => parseInt(ch, 10));
    }

    /**
     * æ¸²æŸ“æ•°ä½æ ¼å­
     * @param {number} num
     * @param {string|null} highlightPlace éœ€è¦é«˜äº®çš„ä½å
     * @param {boolean} showArrow æ˜¯å¦åœ¨ä¸ªä½ä¸‹æ˜¾ç¤ºç®­å¤´ï¼ˆæ™®é€šæ¨¡å¼ç­”é”™æ—¶ï¼‰
     */
    function renderDigitGrid(num, highlightPlace, showArrow) {
      const digits = splitNumber(num);
      const len = digits.length;
      digitGridEl.innerHTML = "";

      for (let i = 0; i < len; i++) {
        const col = document.createElement("div");
        col.className = "digit-col";

        const valueDiv = document.createElement("div");
        valueDiv.className = "digit-value";
        valueDiv.textContent = digits[i];

        const labelDiv = document.createElement("div");
        labelDiv.className = "digit-label";
        const indexFromRight = len - 1 - i;
        const placeName = placeNames[indexFromRight] || "";
        labelDiv.textContent = placeName;

        if (placeName === highlightPlace) {
          col.classList.add("highlight");
        }

        col.appendChild(valueDiv);
        col.appendChild(labelDiv);

        // åªåœ¨â€œæ™®é€šæ¨¡å¼ & åšé”™é¢˜â€æ—¶ï¼Œä¸ªä½ä¸‹å‡ºç°ç®­å¤´
        if (showArrow && !challengeActive && placeName === "ä¸ª") {
          const arrowDiv = document.createElement("div");
          arrowDiv.className = "digit-arrow";
          arrowDiv.textContent = "â†‘";
          col.appendChild(arrowDiv);
        }

        digitGridEl.appendChild(col);
      }
    }

    // ===== å‡ºé¢˜é€»è¾‘ =====
    function newQuestion() {
      const level = levels[currentLevelIndex];
      answered = false;
      feedbackEl.textContent = "";
      feedbackEl.className = "feedback";
      btnNext.disabled = true;

      currentNumber = randomIntegerWithDigits(level.minDigits, level.maxDigits);
      const digits = splitNumber(currentNumber);
      bigNumberEl.textContent = currentNumber.toLocaleString("zh-CN");

      // éšæœºé€‰ä¸€ä¸ªå­˜åœ¨çš„æ•°ä½
      let placeName;
      while (true) {
        placeName = level.placeRange[Math.floor(Math.random() * level.placeRange.length)];
        const indexFromRight = placeIndexFromRight(placeName);
        if (indexFromRight < digits.length) break;
      }
      const correctDigit = digits[digits.length - 1 - placeIndexFromRight(placeName)];

      currentQuestion = { placeName, correctDigit };

      questionTextEl.textContent =
        `é¢˜ç›®ï¼šåœ¨è¿™ä¸ªæ•°é‡Œï¼Œâ€œ${placeName}ä½â€ä¸Šçš„æ•°å­—æ˜¯å¤šå°‘ï¼Ÿ`;

      renderDigitGrid(currentNumber, null, false);

      // æŒ‘æˆ˜æ¨¡å¼ä¸‹éšè—æç¤ºåŒº
      if (challengeActive) {
        towerTipEl.style.display = "none";
      } else {
        towerTipEl.style.display = "block";
        towerTipEl.textContent = placeExplain;
      }

      buildOptions(correctDigit, digits);
    }

    function buildOptions(correctDigit, digits) {
      optionsGridEl.innerHTML = "";
      const options = new Set();
      options.add(correctDigit);

      for (let d of digits) {
        if (options.size >= 4) break;
        if (d !== correctDigit) options.add(d);
      }
      while (options.size < 4) {
        const rand = Math.floor(Math.random() * 10);
        options.add(rand);
      }

      shuffle(Array.from(options)).forEach(val => {
        const btn = document.createElement("button");
        btn.className = "num-btn";
        btn.textContent = val;
        btn.addEventListener("click", () => handleAnswer(val, btn));
        optionsGridEl.appendChild(btn);
      });
    }

    // ===== ç­”é¢˜å¤„ç† =====
    function handleAnswer(val, btn) {
      if (answered) return;
      answered = true;

      const { placeName, correctDigit } = currentQuestion;
      const level = levels[currentLevelIndex];

      optionsGridEl.querySelectorAll(".num-btn").forEach(b => b.disabled = true);

      const digits = splitNumber(currentNumber);
      const len = digits.length;
      const idxRight = placeIndexFromRight(placeName);
      const idxLeft = len - 1 - idxRight;
      const realDigit = digits[idxLeft];

      const isCorrect = (val === correctDigit);

      if (isCorrect) {
        btn.classList.add("correct");
        feedbackEl.className = "feedback ok";

        if (challengeActive) {
          // æŒ‘æˆ˜æ¨¡å¼ï¼šåªè®°æ•°é‡
          challengeScore += 1;
          feedbackEl.textContent =
            `âœ… å¾ˆå¥½ï¼ä½ åœ¨æŒ‘æˆ˜æ¨¡å¼ä¸­åˆç­”å¯¹äº†ä¸€é¢˜ï¼Œç›®å‰æ€»å…±ç­”å¯¹ ${challengeScore} é¢˜ã€‚`;
          challengeStatusEl.textContent =
            `æŒ‘æˆ˜æ¨¡å¼è¿›è¡Œä¸­ï¼šå‰©ä½™ ${challengeTimeLeft} ç§’ï¼Œå·²ç­”å¯¹ ${challengeScore} é¢˜ã€‚`;
        } else {
          feedbackEl.textContent =
            `âœ… å¾ˆæ£’ï¼ä½ æ‰¾å¯¹äº†ã€‚â€œ${placeName}ä½â€ä¸Šçš„æ•°å­—å°±æ˜¯ ${realDigit}ã€‚`;

          correctInLevel += 1;
          totalScore += 10;
          totalScoreEl.textContent = totalScore;
          levelProgressEl.textContent = `${correctInLevel} / 5`;

          // æœ¬ç­‰çº§å®Œæˆ 5 é¢˜
          if (correctInLevel >= 5 && !levelCleared[currentLevelIndex]) {
            levelCleared[currentLevelIndex] = true;
            updateDiffButtons();
            feedbackEl.textContent +=
              ` ğŸ‰ ä½ å·²ç»å®Œæˆâ€œ${level.name}â€çš„ 5 é¢˜æŒ‘æˆ˜ï¼Œå¯ä»¥ç»§ç»­ç»ƒä¹ ï¼Œ` +
              `ä¹Ÿå¯ä»¥ç‚¹å‡»ä¸Šæ–¹åˆ‡æ¢åˆ°å…¶å®ƒç­‰çº§ã€‚`;

            // ä¸‰ä¸ªç­‰çº§éƒ½å®Œæˆï¼Œè§£é”æŒ‘æˆ˜æ¨¡å¼
            if (levelCleared.every(v => v)) {
              unlockChallenge();
            }
          }
        }

        // æ­£ç¡®æ—¶é«˜äº®æ•°ä½ï¼ˆæŒ‘æˆ˜æ¨¡å¼ä¹Ÿå¯ä»¥ç»™è¿™ä¸ªè§†è§‰åé¦ˆï¼‰
        renderDigitGrid(currentNumber, placeName, false);
      } else {
        btn.classList.add("wrong");
        feedbackEl.className = "feedback bad";

        // æ™®é€šæ¨¡å¼ï¼šé”™è¯¯ â†’ é«˜äº®æ­£ç¡®ä½ + ä¸ªä½ç®­å¤´ + è¯¦ç»†è§£é‡Š
        if (!challengeActive) {
          renderDigitGrid(currentNumber, placeName, true);

          const needStrengthen =
            "ä½ éœ€è¦å†åŠ å¼ºâ€œä»å³å¾€å·¦æ•°æ•°ä½â€çš„èƒ½åŠ›ï¼šå…ˆæ‰¾åˆ°ä¸ªä½ï¼Œå†å¾€å·¦æ•°åã€ç™¾ã€åƒã€ä¸‡â€¦â€¦";

          feedbackEl.textContent =
            `âŒ è¿™æ¬¡é€‰çš„æ˜¯ ${val}ï¼Œå…¶å®â€œ${placeName}ä½â€ä¸Šçš„æ•°å­—æ˜¯ ${realDigit}ã€‚\n` +
            `æƒ³ä¸€æƒ³ï¼šä»å³è¾¹å¼€å§‹æ•°ï¼Œç¬¬ 1 ä½æ˜¯â€œä¸ªä½â€ï¼Œç¬¬ 2 ä½æ˜¯â€œåä½â€ï¼Œç¬¬ 3 ä½æ˜¯â€œç™¾ä½â€â€¦â€¦\n` +
            `å°å»ºè®®ï¼š${needStrengthen}`;

          towerTipEl.style.display = "block";
          towerTipEl.textContent =
            "ä»å³å¾€å·¦æ•°ï¼š\n" +
            "ç¬¬ 1 ä½æ˜¯â€œä¸ªâ€ï¼Œç¬¬ 2 ä½æ˜¯â€œåâ€ï¼Œç¬¬ 3 ä½æ˜¯â€œç™¾â€ï¼Œç¬¬ 4 ä½æ˜¯â€œåƒâ€ï¼Œç¬¬ 5 ä½æ˜¯â€œä¸‡â€â€¦â€¦\n" +
            "ç®­å¤´ â†‘ æé†’ä½ ï¼šè¦ä»â€œä¸ªä½â€å¼€å§‹å¾€å·¦æ•°ã€‚";
        } else {
          // æŒ‘æˆ˜æ¨¡å¼ä¸‹ï¼šåªç®€å•æç¤ºï¼Œä¸é¢å¤–ç®­å¤´/é•¿ç¯‡æ•™å­¦
          renderDigitGrid(currentNumber, null, false);
          feedbackEl.textContent =
            `âŒ è¿™é¢˜æ²¡å¯¹ï¼Œç»§ç»­åŠ æ²¹ï¼æŒ‘æˆ˜æ¨¡å¼ä¸‹ä¸ä¼šç»™å¤ªå¤šæç¤ºï¼Œé ä½ çš„è®°å¿†å’Œååº”å•¦ã€‚`;
        }
      }

      btnNext.disabled = false;

      if (challengeActive) {
        // æŒ‘æˆ˜æ¨¡å¼ï¼šè‡ªåŠ¨ä¸‹ä¸€é¢˜
        setTimeout(() => {
          newQuestion();
        }, 350);
      }
    }

    // ===== UI æ›´æ–° =====
    function updateLevelUI() {
      const level = levels[currentLevelIndex];
      levelLabelEl.textContent = level.name;
      levelProgressEl.textContent = `${correctInLevel} / 5`;
      if (!challengeActive) {
        towerTipEl.style.display = "block";
        towerTipEl.textContent = placeExplain;
      }
    }

    function updateDiffButtons() {
      diffButtons.forEach((btn, idx) => {
        btn.classList.toggle("active", idx === currentLevelIndex);
        if (levelCleared[idx]) {
          btn.classList.add("cleared");
        } else {
          btn.classList.remove("cleared");
        }
      });
    }

    diffButtons.forEach((btn, idx) => {
      btn.addEventListener("click", () => {
        if (challengeActive) return; // æŒ‘æˆ˜ä¸­ä¸å…è®¸åˆ‡æ¢ç­‰çº§
        currentLevelIndex = idx;
        correctInLevel = 0;
        updateDiffButtons();
        updateLevelUI();
        feedbackEl.textContent = "";
        feedbackEl.className = "feedback";
        newQuestion();
      });
    });

    btnNext.addEventListener("click", () => {
      if (challengeActive) return;
      newQuestion();
    });

    btnRestart.addEventListener("click", () => {
      if (challengeActive) return;
      correctInLevel = 0;
      updateLevelUI();
      feedbackEl.textContent = "";
      feedbackEl.className = "feedback";
      newQuestion();
    });

    btnHelp.addEventListener("click", () => {
      if (challengeActive) return;
      const level = levels[currentLevelIndex];
      feedbackEl.className = "feedback";
      feedbackEl.textContent =
        `ğŸ” å°æç¤ºï¼š${level.tip}\n` +
        "ä»å³å¾€å·¦è¯»ï¼šç¬¬ 1 ä½æ˜¯â€œä¸ªä½â€ï¼Œç¬¬ 2 ä½æ˜¯â€œåä½â€ï¼Œç¬¬ 3 ä½æ˜¯â€œç™¾ä½â€ï¼Œä¾æ¬¡å¾€å·¦ã€‚";
    });

    // ===== æ’è¡Œæ¦œ & æŒ‘æˆ˜æ¨¡å¼ =====
    function getLeaderboard() {
      try {
        const raw = localStorage.getItem("g4_world1_leaderboard");
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function saveLeaderboard(list) {
      try {
        localStorage.setItem("g4_world1_leaderboard", JSON.stringify(list));
      } catch {}
    }

    function renderLeaderboard() {
      const list = getLeaderboard();
      if (!list.length) {
        leaderboardEl.textContent = "æŒ‘æˆ˜æ’è¡Œæ¦œï¼šè¿˜æ²¡æœ‰è®°å½•ï¼Œå¿«æ¥æˆä¸ºç¬¬ä¸€ä¸ªå§ï¼";
        return;
      }
      let html = "<strong>æŒ‘æˆ˜æ’è¡Œæ¦œï¼ˆ60 ç§’å†…ç­”å¯¹é¢˜æ•°ï¼‰ï¼š</strong><br>";
      list.forEach((item, idx) => {
        const date = new Date(item.time);
        const label =
          `${date.getMonth()+1}/${date.getDate()} ` +
          `${String(date.getHours()).padStart(2,"0")}:${String(date.getMinutes()).padStart(2,"0")}`;
        html += `${idx+1}. ${item.score} é¢˜ï¼ˆ${label}ï¼‰<br>`;
      });
      leaderboardEl.innerHTML = html;
    }

    function updateLeaderboard(score) {
      let list = getLeaderboard();
      list.push({ score, time: Date.now() });
      list.sort((a,b) => {
        if (b.score !== a.score) return b.score - a.score;
        return a.time - b.time;
      });
      list = list.slice(0, 5);
      saveLeaderboard(list);
      renderLeaderboard();
    }

    function unlockChallenge() {
      if (challengeUnlocked) return;
      challengeUnlocked = true;
      try {
        localStorage.setItem("g4_world1_challenge_unlocked", "1");
      } catch {}
      btnChallenge.disabled = false;
      btnChallenge.textContent = "ğŸ”¥ æŒ‘æˆ˜æ¨¡å¼ï¼š1 åˆ†é’Ÿé€Ÿæˆ˜ï¼ˆå·²è§£é”ï¼Œç‚¹å‡»å¼€å§‹ï¼‰";
      challengeStatusEl.textContent =
        "æŒ‘æˆ˜æ¨¡å¼å·²è§£é”ï¼š60 ç§’å†…å°½é‡å¤šåšé¢˜ï¼é¢˜ç›®ä½¿ç”¨â€œå›°éš¾ç­‰çº§â€çš„å¤§æ•°å“¦ã€‚";
    }

    function loadChallengeUnlock() {
      try {
        const flag = localStorage.getItem("g4_world1_challenge_unlocked");
        if (flag === "1") {
          challengeUnlocked = true;
          btnChallenge.disabled = false;
          btnChallenge.textContent = "ğŸ”¥ æŒ‘æˆ˜æ¨¡å¼ï¼š1 åˆ†é’Ÿé€Ÿæˆ˜ï¼ˆå·²è§£é”ï¼Œç‚¹å‡»å¼€å§‹ï¼‰";
          challengeStatusEl.textContent =
            "æŒ‘æˆ˜æ¨¡å¼å·²è§£é”ï¼š60 ç§’å†…å°½é‡å¤šåšé¢˜ï¼é¢˜ç›®ä½¿ç”¨â€œå›°éš¾ç­‰çº§â€çš„å¤§æ•°å“¦ã€‚";
        }
      } catch {}
    }

    function startChallenge() {
      if (!challengeUnlocked || challengeActive) return;

      challengeActive = true;
      challengeScore = 0;
      challengeTimeLeft = 60;

      // ä½¿ç”¨â€œå›°éš¾ç­‰çº§â€å‡ºé¢˜
      currentLevelIndex = 2;
      correctInLevel = 0;
      updateDiffButtons();

      levelLabelEl.textContent = "æŒ‘æˆ˜æ¨¡å¼ï¼š1 åˆ†é’Ÿé€Ÿæˆ˜";
      levelProgressEl.textContent = "-";
      feedbackEl.textContent = "";
      feedbackEl.className = "feedback";

      btnRestart.disabled = true;
      btnHelp.disabled = true;
      btnNext.disabled = true;

      towerTipEl.style.display = "none"; // æŒ‘æˆ˜æ¨¡å¼ä¸‹ä¸æ˜¾ç¤ºæ•°å­—ä¸‹æ–¹æç¤º

      challengeStatusEl.textContent =
        `æŒ‘æˆ˜æ¨¡å¼è¿›è¡Œä¸­ï¼šå‰©ä½™ ${challengeTimeLeft} ç§’ï¼Œå·²ç­”å¯¹ 0 é¢˜ã€‚`;

      if (challengeTimerId) clearInterval(challengeTimerId);
      challengeTimerId = setInterval(() => {
        challengeTimeLeft--;
        if (challengeTimeLeft <= 0) {
          endChallenge();
        } else {
          challengeStatusEl.textContent =
            `æŒ‘æˆ˜æ¨¡å¼è¿›è¡Œä¸­ï¼šå‰©ä½™ ${challengeTimeLeft} ç§’ï¼Œå·²ç­”å¯¹ ${challengeScore} é¢˜ã€‚`;
        }
      }, 1000);

      newQuestion();
    }

    function endChallenge() {
      if (!challengeActive) return;
      challengeActive = false;
      clearInterval(challengeTimerId);
      challengeTimerId = null;

      challengeStatusEl.textContent =
        `æœ¬è½®ç»“æŸï¼šä½ åœ¨ 60 ç§’å†…ä¸€å…±ç­”å¯¹äº† ${challengeScore} é¢˜ï¼å¯ä»¥å†è¯•ä¸€æ¬¡æŒ‘æˆ˜ï¼Œæˆ–è€…å›åˆ°æ™®é€šæ¨¡å¼ç»§ç»­ç»ƒä¹ ã€‚`;

      btnRestart.disabled = false;
      btnHelp.disabled = false;
      btnNext.disabled = false;

      // æ¢å¤åˆ°å½“å‰ç­‰çº§ UIï¼ˆé»˜è®¤ä¸ºå›°éš¾ç­‰çº§ï¼‰
      currentLevelIndex = 2;
      updateLevelUI();

      updateLeaderboard(challengeScore);
    }

    btnChallenge.addEventListener("click", () => {
      if (!challengeUnlocked) return;
      startChallenge();
    });

    // ===== åˆå§‹åŒ– =====
    function init() {
      loadChallengeUnlock();
      renderLeaderboard();
      updateDiffButtons();
      updateLevelUI();
      newQuestion();
    }

    init();
  </script>
</body>
</html>
