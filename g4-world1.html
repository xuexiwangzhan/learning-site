<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å››å¹´çº§æ•°å­¦ Â· ä¸–ç•Œåˆé›†</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: radial-gradient(circle at top, #020617, #020617 40%, #000 100%);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px 10px 40px;
    }
    .container {
      width: 100%;
      max-width: 960px;
    }
    a.back {
      display: inline-block;
      margin-bottom: 8px;
      font-size: 13px;
      color: #38bdf8;
      text-decoration: none;
    }
    a.back:hover { text-decoration: underline; }

    h1 {
      margin: 4px 0;
      font-size: 24px;
    }
    .subtitle {
      font-size: 14px;
      color: #9ca3af;
      margin-bottom: 12px;
      line-height: 1.5;
    }

    /* ä¸–ç•Œåˆ‡æ¢æ ‡ç­¾ */
    .world-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
    }
    .world-tab {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
      padding: 6px 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all .15s ease;
    }
    .world-tab span.badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      color: #9ca3af;
    }
    .world-tab.active {
      background: #2563eb;
      border-color: #60a5fa;
      color: #fff;
    }

    .world {
      display: none;
    }
    .world.active {
      display: block;
    }

    .card {
      background: rgba(15,23,42,0.96);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 16px 40px rgba(15,23,42,0.9);
      border: 1px solid #1f2937;
      margin-top: 8px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 14px;
      color: #9ca3af;
      margin-bottom: 10px;
    }
    .badge-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      font-size: 12px;
      color: #cbd5f5;
    }
    .badge-pill span.level {
      font-weight: bold;
      color: #facc15;
    }

    .difficulty-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
      font-size: 13px;
      align-items: center;
    }
    .diff-label {
      color: #9ca3af;
    }
    .diff-btn {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      padding: 4px 10px;
      font-size: 13px;
      cursor: pointer;
      transition: all .15s ease;
    }
    .diff-btn.active {
      background: #2563eb;
      border-color: #60a5fa;
      color: #fff;
    }
    .diff-btn.cleared::after {
      content: " âœ”";
      color: #4ade80;
      font-size: 11px;
    }

    .challenge-zone {
      margin-bottom: 12px;
      padding: 8px 10px;
      border-radius: 12px;
      background: #020617;
      border: 1px dashed #374151;
      font-size: 13px;
      color: #9ca3af;
    }
    .challenge-zone button {
      margin-bottom: 6px;
    }
    .challenge-status {
      margin-bottom: 4px;
    }
    .leaderboard {
      font-size: 12px;
      color: #9ca3af;
      line-height: 1.4;
    }

    .board {
      margin: 6px 0 12px;
      border-radius: 14px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 14px;
    }
    .prompt {
      font-size: 15px;
      margin-bottom: 8px;
    }
    .big-number {
      font-size: 28px;
      letter-spacing: 3px;
      text-align: center;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #020617;
      margin-bottom: 10px;
    }

    .digit-grid {
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: minmax(0, 1fr);
      gap: 4px;
      margin-top: 6px;
      overflow-x: auto;
      padding-bottom: 4px;
    }
    .digit-col {
      text-align: center;
      min-width: 46px;
    }
    .digit-value {
      font-size: 18px;
      padding: 4px 0;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      margin-bottom: 3px;
    }
    .digit-label {
      font-size: 11px;
      color: #a5b4fc;
    }
    .digit-arrow {
      font-size: 13px;
      color: #fbbf24;
      margin-top: 2px;
      line-height: 1;
    }
    .digit-col.highlight .digit-value {
      background: #1d4ed8;
      border-color: #60a5fa;
    }
    .digit-col.highlight .digit-label {
      color: #fde68a;
      font-weight: bold;
    }

    .tower-tip {
      font-size: 13px;
      color: #9ca3af;
      margin-top: 6px;
      white-space: pre-line;
    }

    .num-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin: 8px 0;
    }
    .num-btn {
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 16px;
      padding: 8px 0;
      cursor: pointer;
      transition: all .15s ease;
    }
    .num-btn:hover {
      background: #0b1120;
      border-color: #38bdf8;
    }
    .num-btn.correct {
      background: #16a34a;
      border-color: #22c55e;
      color: #e5fdf0;
    }
    .num-btn.wrong {
      background: #7f1d1d;
      border-color: #ef4444;
      color: #fee2e2;
    }

    .feedback {
      min-height: 40px;
      font-size: 14px;
      margin-top: 4px;
      line-height: 1.4;
    }
    .feedback.ok { color: #4ade80; }
    .feedback.bad { color: #fecaca; }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    .btn {
      border-radius: 999px;
      padding: 6px 16px;
      font-size: 14px;
      border: none;
      cursor: pointer;
      transition: all .15s ease;
    }
    .btn-main {
      background: #2563eb;
      color: #fff;
    }
    .btn-main:disabled {
      background: #1f2937;
      color: #6b7280;
      cursor: not-allowed;
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid #4b5563;
      color: #9ca3af;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    /* ä¸–ç•ŒäºŒ ä¸“ç”¨å¸ƒå±€ */
    .capacity-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 14px;
      align-items: center;
      margin-bottom: 6px;
    }
    .capacity-highlight {
      color: #facc15;
      font-weight: bold;
    }

    @media (max-width: 640px) {
      .big-number { font-size: 24px; }
      .num-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="math.html" class="back">âª è¿”å›æ•°å­¦å­¦ä¹ ä¸­å¿ƒ</a>

    <h1>å››å¹´çº§æ•°å­¦ Â· å†’é™©ä¸–ç•Œåˆé›†</h1>
    <div class="subtitle">
      æ‰€æœ‰å››å¹´çº§æ•°å­¦ä¸–ç•Œéƒ½é›†ä¸­åœ¨è¿™ä¸ªé¡µé¢ï¼š<br/>
      ä¸–ç•Œä¸€ï¼šæ•°ä½å¡”æ¥¼å®ˆæŠ¤ï¼ˆå¤§æ•°çš„æ•°ä½ï¼‰<br/>
      ä¸–ç•ŒäºŒï¼šå‡å’Œæ¯«å‡å®éªŒå®¤ï¼ˆå®¹é‡å•ä½ä¸æ¢ç®—ï¼‰<br/>
      ä»¥åè¿˜å¯ä»¥ç»§ç»­åŠ ï¼šç»Ÿè®¡å›¾ä¸–ç•Œã€å››åˆ™è¿ç®—ä¸–ç•Œã€å‚ç›´å¹³è¡Œçº¿ä¸–ç•Œâ€¦â€¦  
    </div>

    <!-- ä¸–ç•Œåˆ‡æ¢æ ‡ç­¾ -->
    <div class="world-tabs">
      <button class="world-tab active" data-world="world1">
        ğŸŒ† ä¸–ç•Œä¸€ï¼šæ•°ä½å¡”æ¥¼å®ˆæŠ¤
        <span class="badge">å¤§æ•°çš„æ•°ä½</span>
      </button>
      <button class="world-tab" data-world="world2">
        ğŸ§ª ä¸–ç•ŒäºŒï¼šå‡å’Œæ¯«å‡å®éªŒå®¤
        <span class="badge">å®¹é‡å•ä½</span>
      </button>
    </div>

    <!-- ================== ä¸–ç•Œä¸€ï¼šæ•°ä½å¡”æ¥¼å®ˆæŠ¤ ================== -->
    <div class="world active" id="world1">
      <div class="card">
        <div class="top-bar">
          <div class="badge-pill">
            å½“å‰æ¨¡å¼ï¼š
            <span class="level" id="w1-level-label">Lv.1 ç®€å• Â· ä¸‡ä»¥å†…</span>
          </div>
          <div class="badge-pill">
            æœ¬ç­‰çº§è¿›åº¦ï¼š<span id="w1-level-progress">0 / 5</span>
          </div>
          <div class="badge-pill">
            æ€»å¾—åˆ†ï¼š<span id="w1-total-score">0</span>
          </div>
        </div>

        <div class="difficulty-row">
          <span class="diff-label">é€‰æ‹©ç­‰çº§ï¼ˆå»ºè®®å…ˆä»ç®€å•å¼€å§‹ï¼‰ï¼š</span>
          <button class="diff-btn active" data-w1-level="0" id="w1-btn-level-0">ç®€å•</button>
          <button class="diff-btn" data-w1-level="1" id="w1-btn-level-1">ä¸­ç­‰</button>
          <button class="diff-btn" data-w1-level="2" id="w1-btn-level-2">å›°éš¾</button>
        </div>

        <div class="challenge-zone">
          <button class="btn btn-ghost" id="w1-btn-challenge" disabled>
            ğŸ”’ æŒ‘æˆ˜æ¨¡å¼ï¼šå®Œæˆä¸‰ä¸ªç­‰çº§åè§£é”
          </button>
          <div class="challenge-status" id="w1-challenge-status">
            å®Œæˆç®€å•ã€ä¸­ç­‰ã€å›°éš¾ä¸‰ä¸ªç­‰çº§å„ 5 é¢˜åï¼Œå°±å¯ä»¥å¼€å¯ 60 ç§’æŒ‘æˆ˜ã€‚
          </div>
          <div class="leaderboard" id="w1-leaderboard">
            æŒ‘æˆ˜æ’è¡Œæ¦œï¼šè¿˜æ²¡æœ‰è®°å½•ï¼Œç­‰ä½ æ¥æŒ‘æˆ˜ï¼
          </div>
        </div>

        <div class="board">
          <div class="prompt" id="w1-question-text">
            é¢˜ç›®åŠ è½½ä¸­â€¦â€¦
          </div>
          <div class="big-number" id="w1-big-number">00000</div>

          <div class="digit-grid" id="w1-digit-grid"></div>
          <div class="tower-tip" id="w1-tower-tip">
            æ•°ä½ä»å³å¾€å·¦ä¾æ¬¡æ˜¯ï¼šä¸ªã€åã€ç™¾ã€åƒã€ä¸‡ã€åä¸‡ã€ç™¾ä¸‡ã€åƒä¸‡ã€äº¿â€¦â€¦
          </div>
        </div>

        <div class="prompt">è¯·é€‰æ‹©ä½ è®¤ä¸ºæ­£ç¡®çš„ç­”æ¡ˆï¼š</div>
        <div class="num-grid" id="w1-options-grid"></div>

        <div class="feedback" id="w1-feedback"></div>

        <div class="controls">
          <button class="btn btn-ghost" id="w1-btn-help">ğŸ“š çœ‹æç¤º</button>
          <div style="display:flex; gap:8px;">
            <button class="btn btn-ghost" id="w1-btn-restart">ğŸ” é‡ç½®æœ¬ç­‰çº§è¿›åº¦</button>
            <button class="btn btn-main" id="w1-btn-next" disabled>ä¸‹ä¸€é¢˜ â–¶</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ================== ä¸–ç•ŒäºŒï¼šå‡å’Œæ¯«å‡å®éªŒå®¤ ================== -->
    <div class="world" id="world2">
      <div class="card">
        <div class="top-bar">
          <div class="badge-pill">
            å½“å‰æ¨¡å¼ï¼š
            <span class="level" id="w2-level-label">Lv.1 ç®€å• Â· ç›´æ¥æ¢ç®—</span>
          </div>
          <div class="badge-pill">
            æœ¬ç­‰çº§è¿›åº¦ï¼š<span id="w2-level-progress">0 / 5</span>
          </div>
          <div class="badge-pill">
            æ€»å¾—åˆ†ï¼š<span id="w2-total-score">0</span>
          </div>
        </div>

        <div class="difficulty-row">
          <span class="diff-label">é€‰æ‹©ç­‰çº§ï¼š</span>
          <button class="diff-btn active" data-w2-level="0" id="w2-btn-level-0">ç®€å•</button>
          <button class="diff-btn" data-w2-level="1" id="w2-btn-level-1">ä¸­ç­‰</button>
          <button class="diff-btn" data-w2-level="2" id="w2-btn-level-2">å›°éš¾</button>
        </div>

        <div class="challenge-zone">
          <button class="btn btn-ghost" id="w2-btn-challenge" disabled>
            ğŸ”’ æŒ‘æˆ˜æ¨¡å¼ï¼šå®Œæˆä¸‰ä¸ªç­‰çº§åè§£é”
          </button>
          <div class="challenge-status" id="w2-challenge-status">
            å®Œæˆä¸‰ä¸ªç­‰çº§å„ 5 é¢˜åï¼Œå¯ä»¥å¼€å¯ 60 ç§’â€œå®¹é‡æ¢ç®—é€Ÿæˆ˜â€ã€‚
          </div>
          <div class="leaderboard" id="w2-leaderboard">
            æŒ‘æˆ˜æ’è¡Œæ¦œï¼šè¿˜æ²¡æœ‰è®°å½•ï¼Œç­‰ä½ æ¥æŒ‘æˆ˜ï¼
          </div>
        </div>

        <div class="board">
          <div class="prompt" id="w2-question-text">
            é¢˜ç›®åŠ è½½ä¸­â€¦â€¦
          </div>

          <div class="board-inner">
            <div class="big-number" id="w2-capacity-display">1 L = 1000 mL</div>
            <div class="capacity-row" id="w2-capacity-tip">
              æç¤ºï¼š<span class="capacity-highlight">1 å‡ = 1000 æ¯«å‡</span>ã€‚
              å…ˆç®—â€œæœ‰å¤šå°‘ä¸ª 1000â€ï¼Œå†çœ‹è¿˜å‰©å¤šå°‘ã€‚
            </div>
          </div>
        </div>

        <div class="prompt">è¯·é€‰æ‹©ä½ è®¤ä¸ºæ­£ç¡®çš„ç­”æ¡ˆï¼š</div>
        <div class="num-grid" id="w2-options-grid"></div>

        <div class="feedback" id="w2-feedback"></div>

        <div class="controls">
          <button class="btn btn-ghost" id="w2-btn-help">ğŸ“š çœ‹æç¤º</button>
          <div style="display:flex; gap:8px;">
            <button class="btn btn-ghost" id="w2-btn-restart">ğŸ” é‡ç½®æœ¬ç­‰çº§è¿›åº¦</button>
            <button class="btn btn-main" id="w2-btn-next" disabled>ä¸‹ä¸€é¢˜ â–¶</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    /* ============== ä¸–ç•Œåˆ‡æ¢æŒ‰é’® ============== */
    const worldTabs = document.querySelectorAll(".world-tab");
    const worlds = document.querySelectorAll(".world");
    worldTabs.forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-world");
        worldTabs.forEach(b => b.classList.remove("active"));
        worlds.forEach(w => w.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(target).classList.add("active");
      });
    });

    /* ================== ä¸–ç•Œä¸€ï¼šæ•°ä½å¡”æ¥¼å®ˆæŠ¤ ================== */

    const placeNames = ["ä¸ª","å","ç™¾","åƒ","ä¸‡","åä¸‡","ç™¾ä¸‡","åƒä¸‡","äº¿","åäº¿","ç™¾äº¿"];
    const placeExplain =
      "æ•°ä½ä»å³å¾€å·¦ä¾æ¬¡æ˜¯ï¼šä¸ªã€åã€ç™¾ã€åƒã€ä¸‡ã€åä¸‡ã€ç™¾ä¸‡ã€åƒä¸‡ã€äº¿â€¦â€¦";

    const w1Levels = [
      {
        id: 1,
        name: "Lv.1 ç®€å• Â· ä¸‡ä»¥å†…",
        minDigits: 4,
        maxDigits: 5,
        placeRange: ["ä¸ª","å","ç™¾","åƒ","ä¸‡"],
        tip: "æœ¬ç­‰çº§å…ˆç†Ÿæ‚‰ä¸‡ä»¥å†…ï¼šä¸ªã€åã€ç™¾ã€åƒã€ä¸‡ã€‚"
      },
      {
        id: 2,
        name: "Lv.2 ä¸­ç­‰ Â· ç™¾ä¸‡ä»¥å†…",
        minDigits: 5,
        maxDigits: 7,
        placeRange: ["ä¸ª","å","ç™¾","åƒ","ä¸‡","åä¸‡","ç™¾ä¸‡"],
        tip: "åŠ å…¥åä¸‡ã€ç™¾ä¸‡ï¼šè®°ä½â€œä¸‡â€å·¦è¾¹ä¸€ä½æ˜¯â€œåä¸‡â€ã€‚"
      },
      {
        id: 3,
        name: "Lv.3 å›°éš¾ Â· äº¿ä»¥å†…",
        minDigits: 7,
        maxDigits: 9,
        placeRange: ["ä¸ª","å","ç™¾","åƒ","ä¸‡","åä¸‡","ç™¾ä¸‡","åƒä¸‡","äº¿"],
        tip: "æŒæ¡åˆ°â€œäº¿â€ï¼šä¸‡çš„ä¸‡å€æ˜¯äº¿ã€‚"
      }
    ];

    let w1CurrentLevelIndex = 0;
    let w1CorrectInLevel = 0;
    let w1LevelCleared = [false,false,false];
    let w1TotalScore = 0;

    let w1CurrentNumber = 0;
    let w1CurrentQuestion = null;
    let w1Answered = false;

    let w1ChallengeUnlocked = false;
    let w1ChallengeActive = false;
    let w1ChallengeScore = 0;
    let w1ChallengeTimeLeft = 0;
    let w1ChallengeTimerId = null;

    const w1LevelLabelEl = document.getElementById("w1-level-label");
    const w1LevelProgressEl = document.getElementById("w1-level-progress");
    const w1TotalScoreEl = document.getElementById("w1-total-score");
    const w1BigNumberEl = document.getElementById("w1-big-number");
    const w1DigitGridEl = document.getElementById("w1-digit-grid");
    const w1QuestionTextEl = document.getElementById("w1-question-text");
    const w1OptionsGridEl = document.getElementById("w1-options-grid");
    const w1FeedbackEl = document.getElementById("w1-feedback");
    const w1TowerTipEl = document.getElementById("w1-tower-tip");

    const w1BtnNext = document.getElementById("w1-btn-next");
    const w1BtnRestart = document.getElementById("w1-btn-restart");
    const w1BtnHelp = document.getElementById("w1-btn-help");

    const w1BtnChallenge = document.getElementById("w1-btn-challenge");
    const w1ChallengeStatusEl = document.getElementById("w1-challenge-status");
    const w1LeaderboardEl = document.getElementById("w1-leaderboard");

    const w1DiffButtons = [
      document.getElementById("w1-btn-level-0"),
      document.getElementById("w1-btn-level-1"),
      document.getElementById("w1-btn-level-2")
    ];

    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }

    function placeIndexFromRight(name) {
      return placeNames.indexOf(name);
    }

    function randomIntegerWithDigits(minDigits, maxDigits) {
      const digits = randInt(minDigits, maxDigits);
      const min = Math.pow(10, digits - 1);
      const max = Math.pow(10, digits) - 1;
      return randInt(min, max);
    }

    function splitNumber(num) {
      return String(num).split("").map(ch => parseInt(ch, 10));
    }

    function w1RenderDigitGrid(num, highlightPlace, showArrow) {
      const digits = splitNumber(num);
      const len = digits.length;
      w1DigitGridEl.innerHTML = "";
      for (let i = 0; i < len; i++) {
        const col = document.createElement("div");
        col.className = "digit-col";

        const valueDiv = document.createElement("div");
        valueDiv.className = "digit-value";
        valueDiv.textContent = digits[i];

        const labelDiv = document.createElement("div");
        labelDiv.className = "digit-label";

        const indexFromRight = len - 1 - i;
        const placeName = placeNames[indexFromRight] || "";
        labelDiv.textContent = placeName;

        if (placeName === highlightPlace) {
          col.classList.add("highlight");
        }

        col.appendChild(valueDiv);
        col.appendChild(labelDiv);

        if (showArrow && !w1ChallengeActive && placeName === "ä¸ª") {
          const arrowDiv = document.createElement("div");
          arrowDiv.className = "digit-arrow";
          arrowDiv.textContent = "â†‘";
          col.appendChild(arrowDiv);
        }

        w1DigitGridEl.appendChild(col);
      }
    }

    function w1NewQuestion() {
      const level = w1Levels[w1CurrentLevelIndex];
      w1Answered = false;
      w1FeedbackEl.textContent = "";
      w1FeedbackEl.className = "feedback";
      w1BtnNext.disabled = true;

      w1CurrentNumber = randomIntegerWithDigits(level.minDigits, level.maxDigits);
      const digits = splitNumber(w1CurrentNumber);
      w1BigNumberEl.textContent = w1CurrentNumber.toLocaleString("zh-CN");

      let placeName;
      while (true) {
        placeName = level.placeRange[randInt(0, level.placeRange.length - 1)];
        const idxRight = placeIndexFromRight(placeName);
        if (idxRight < digits.length) break;
      }
      const correctDigit = digits[digits.length - 1 - placeIndexFromRight(placeName)];
      w1CurrentQuestion = { placeName, correctDigit };

      w1QuestionTextEl.textContent =
        `é¢˜ç›®ï¼šåœ¨è¿™ä¸ªæ•°é‡Œï¼Œâ€œ${placeName}ä½â€ä¸Šçš„æ•°å­—æ˜¯å¤šå°‘ï¼Ÿ`;

      w1RenderDigitGrid(w1CurrentNumber, null, false);

      if (w1ChallengeActive) {
        w1TowerTipEl.style.display = "none";
      } else {
        w1TowerTipEl.style.display = "block";
        w1TowerTipEl.textContent = placeExplain;
      }

      w1BuildOptions(correctDigit, digits);
    }

    function w1BuildOptions(correctDigit, digits) {
      w1OptionsGridEl.innerHTML = "";
      const options = new Set([correctDigit]);
      for (const d of digits) {
        if (options.size >= 4) break;
        if (d !== correctDigit) options.add(d);
      }
      while (options.size < 4) {
        options.add(randInt(0, 9));
      }
      shuffle(Array.from(options)).forEach(val => {
        const btn = document.createElement("button");
        btn.className = "num-btn";
        btn.textContent = val;
        btn.addEventListener("click", () => w1HandleAnswer(val, btn));
        w1OptionsGridEl.appendChild(btn);
      });
    }

    function w1HandleAnswer(val, btn) {
      if (w1Answered) return;
      w1Answered = true;

      const { placeName, correctDigit } = w1CurrentQuestion;
      const level = w1Levels[w1CurrentLevelIndex];

      w1OptionsGridEl.querySelectorAll(".num-btn").forEach(b => b.disabled = true);

      const digits = splitNumber(w1CurrentNumber);
      const len = digits.length;
      const idxRight = placeIndexFromRight(placeName);
      const idxLeft = len - 1 - idxRight;
      const realDigit = digits[idxLeft];

      const isCorrect = (val === correctDigit);

      if (isCorrect) {
        btn.classList.add("correct");
        w1FeedbackEl.className = "feedback ok";

        if (w1ChallengeActive) {
          w1ChallengeScore += 1;
          w1FeedbackEl.textContent =
            `âœ… å¾ˆå¥½ï¼ä½ åœ¨æŒ‘æˆ˜æ¨¡å¼ä¸­åˆç­”å¯¹äº†ä¸€é¢˜ï¼Œç›®å‰æ€»å…±ç­”å¯¹ ${w1ChallengeScore} é¢˜ã€‚`;
          w1ChallengeStatusEl.textContent =
            `æŒ‘æˆ˜æ¨¡å¼è¿›è¡Œä¸­ï¼šå‰©ä½™ ${w1ChallengeTimeLeft} ç§’ï¼Œå·²ç­”å¯¹ ${w1ChallengeScore} é¢˜ã€‚`;
        } else {
          w1FeedbackEl.textContent =
            `âœ… å¾ˆæ£’ï¼ä½ æ‰¾å¯¹äº†ã€‚â€œ${placeName}ä½â€ä¸Šçš„æ•°å­—å°±æ˜¯ ${realDigit}ã€‚`;

          w1CorrectInLevel += 1;
          w1TotalScore += 10;
          w1TotalScoreEl.textContent = w1TotalScore;
          w1LevelProgressEl.textContent = `${w1CorrectInLevel} / 5`;

          if (w1CorrectInLevel >= 5 && !w1LevelCleared[w1CurrentLevelIndex]) {
            w1LevelCleared[w1CurrentLevelIndex] = true;
            w1UpdateDiffButtons();
            w1FeedbackEl.textContent +=
              ` ğŸ‰ ä½ å·²ç»å®Œæˆâ€œ${level.name}â€çš„ 5 é¢˜æŒ‘æˆ˜ï¼Œå¯ä»¥ç»§ç»­ç»ƒä¹ ï¼Œ` +
              `ä¹Ÿå¯ä»¥åˆ‡æ¢åˆ°å…¶å®ƒç­‰çº§ã€‚`;

            if (w1LevelCleared.every(v => v)) {
              w1UnlockChallenge();
            }
          }
        }
        w1RenderDigitGrid(w1CurrentNumber, placeName, false);
      } else {
        btn.classList.add("wrong");
        w1FeedbackEl.className = "feedback bad";

        if (!w1ChallengeActive) {
          w1RenderDigitGrid(w1CurrentNumber, placeName, true);

          const needStrengthen =
            "ä½ éœ€è¦å†åŠ å¼ºâ€œä»å³å¾€å·¦æ•°æ•°ä½â€çš„èƒ½åŠ›ï¼šå…ˆæ‰¾åˆ°ä¸ªä½ï¼Œå†å¾€å·¦æ•°åã€ç™¾ã€åƒã€ä¸‡â€¦â€¦";

          w1FeedbackEl.textContent =
            `âŒ è¿™æ¬¡é€‰çš„æ˜¯ ${val}ï¼Œå…¶å®â€œ${placeName}ä½â€ä¸Šçš„æ•°å­—æ˜¯ ${realDigit}ã€‚\n` +
            `æƒ³ä¸€æƒ³ï¼šä»å³è¾¹å¼€å§‹æ•°ï¼Œç¬¬ 1 ä½æ˜¯â€œä¸ªä½â€ï¼Œç¬¬ 2 ä½æ˜¯â€œåä½â€ï¼Œç¬¬ 3 ä½æ˜¯â€œç™¾ä½â€â€¦â€¦\n` +
            `å°å»ºè®®ï¼š${needStrengthen}`;

          w1TowerTipEl.style.display = "block";
          w1TowerTipEl.textContent =
            "ä»å³å¾€å·¦æ•°ï¼š\n" +
            "ç¬¬ 1 ä½æ˜¯â€œä¸ªâ€ï¼Œç¬¬ 2 ä½æ˜¯â€œåâ€ï¼Œç¬¬ 3 ä½æ˜¯â€œç™¾â€ï¼Œç¬¬ 4 ä½æ˜¯â€œåƒâ€ï¼Œç¬¬ 5 ä½æ˜¯â€œä¸‡â€â€¦â€¦\n" +
            "ç®­å¤´ â†‘ æé†’ä½ ï¼šè¦ä»â€œä¸ªä½â€å¼€å§‹å¾€å·¦æ•°ã€‚";
        } else {
          w1RenderDigitGrid(w1CurrentNumber, null, false);
          w1FeedbackEl.textContent =
            `âŒ è¿™é¢˜æ²¡å¯¹ï¼Œç»§ç»­åŠ æ²¹ï¼æŒ‘æˆ˜æ¨¡å¼ä¸‹ä¸ä¼šç»™å¤ªå¤šæç¤ºï¼Œé ä½ çš„è®°å¿†å’Œååº”å•¦ã€‚`;
        }
      }

      w1BtnNext.disabled = false;

      if (w1ChallengeActive) {
        setTimeout(() => { w1NewQuestion(); }, 350);
      }
    }

    function w1UpdateLevelUI() {
      const level = w1Levels[w1CurrentLevelIndex];
      w1LevelLabelEl.textContent = level.name;
      w1LevelProgressEl.textContent = `${w1CorrectInLevel} / 5`;
      if (!w1ChallengeActive) {
        w1TowerTipEl.style.display = "block";
        w1TowerTipEl.textContent = placeExplain;
      }
    }

    function w1UpdateDiffButtons() {
      w1DiffButtons.forEach((btn, idx) => {
        btn.classList.toggle("active", idx === w1CurrentLevelIndex);
        if (w1LevelCleared[idx]) btn.classList.add("cleared");
        else btn.classList.remove("cleared");
      });
    }

    w1DiffButtons.forEach((btn, idx) => {
      btn.addEventListener("click", () => {
        if (w1ChallengeActive) return;
        w1CurrentLevelIndex = idx;
        w1CorrectInLevel = 0;
        w1UpdateDiffButtons();
        w1UpdateLevelUI();
        w1FeedbackEl.textContent = "";
        w1FeedbackEl.className = "feedback";
        w1NewQuestion();
      });
    });

    w1BtnNext.addEventListener("click", () => {
      if (w1ChallengeActive) return;
      w1NewQuestion();
    });

    w1BtnRestart.addEventListener("click", () => {
      if (w1ChallengeActive) return;
      w1CorrectInLevel = 0;
      w1UpdateLevelUI();
      w1FeedbackEl.textContent = "";
      w1FeedbackEl.className = "feedback";
      w1NewQuestion();
    });

    w1BtnHelp.addEventListener("click", () => {
      if (w1ChallengeActive) return;
      const level = w1Levels[w1CurrentLevelIndex];
      w1FeedbackEl.className = "feedback";
      w1FeedbackEl.textContent =
        `ğŸ” å°æç¤ºï¼š${level.tip}\n` +
        "ä»å³å¾€å·¦è¯»ï¼šç¬¬ 1 ä½æ˜¯â€œä¸ªä½â€ï¼Œç¬¬ 2 ä½æ˜¯â€œåä½â€ï¼Œç¬¬ 3 ä½æ˜¯â€œç™¾ä½â€ï¼Œä¾æ¬¡å¾€å·¦ã€‚";
    });

    function w1GetLeaderboard() {
      try {
        const raw = localStorage.getItem("g4_world1_leaderboard");
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch { return []; }
    }

    function w1SaveLeaderboard(list) {
      try { localStorage.setItem("g4_world1_leaderboard", JSON.stringify(list)); } catch {}
    }

    function w1RenderLeaderboard() {
      const list = w1GetLeaderboard();
      if (!list.length) {
        w1LeaderboardEl.textContent = "æŒ‘æˆ˜æ’è¡Œæ¦œï¼šè¿˜æ²¡æœ‰è®°å½•ï¼Œå¿«æ¥æˆä¸ºç¬¬ä¸€ä¸ªå§ï¼";
        return;
      }
      let html = "<strong>æŒ‘æˆ˜æ’è¡Œæ¦œï¼ˆ60 ç§’å†…ç­”å¯¹é¢˜æ•°ï¼‰ï¼š</strong><br>";
      list.forEach((item, idx) => {
        const d = new Date(item.time);
        const label =
          `${d.getMonth()+1}/${d.getDate()} ` +
          `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
        html += `${idx+1}. ${item.score} é¢˜ï¼ˆ${label}ï¼‰<br>`;
      });
      w1LeaderboardEl.innerHTML = html;
    }

    function w1UpdateLeaderboard(score) {
      let list = w1GetLeaderboard();
      list.push({ score, time: Date.now() });
      list.sort((a,b) => b.score !== a.score ? b.score - a.score : a.time - b.time);
      list = list.slice(0, 5);
      w1SaveLeaderboard(list);
      w1RenderLeaderboard();
    }

    function w1UnlockChallenge() {
      if (w1ChallengeUnlocked) return;
      w1ChallengeUnlocked = true;
      try { localStorage.setItem("g4_world1_challenge_unlocked", "1"); } catch {}
      w1BtnChallenge.disabled = false;
      w1BtnChallenge.textContent = "ğŸ”¥ æŒ‘æˆ˜æ¨¡å¼ï¼š1 åˆ†é’Ÿé€Ÿæˆ˜ï¼ˆå·²è§£é”ï¼Œç‚¹å‡»å¼€å§‹ï¼‰";
      w1ChallengeStatusEl.textContent =
        "æŒ‘æˆ˜æ¨¡å¼å·²è§£é”ï¼š60 ç§’å†…å°½é‡å¤šåšé¢˜ï¼é¢˜ç›®ä½¿ç”¨â€œå›°éš¾ç­‰çº§â€çš„å¤§æ•°å“¦ã€‚";
    }

    function w1LoadChallengeUnlock() {
      try {
        const flag = localStorage.getItem("g4_world1_challenge_unlocked");
        if (flag === "1") {
          w1ChallengeUnlocked = true;
          w1BtnChallenge.disabled = false;
          w1BtnChallenge.textContent = "ğŸ”¥ æŒ‘æˆ˜æ¨¡å¼ï¼š1 åˆ†é’Ÿé€Ÿæˆ˜ï¼ˆå·²è§£é”ï¼Œç‚¹å‡»å¼€å§‹ï¼‰";
          w1ChallengeStatusEl.textContent =
            "æŒ‘æˆ˜æ¨¡å¼å·²è§£é”ï¼š60 ç§’å†…å°½é‡å¤šåšé¢˜ï¼é¢˜ç›®ä½¿ç”¨â€œå›°éš¾ç­‰çº§â€çš„å¤§æ•°å“¦ã€‚";
        }
      } catch {}
    }

    function w1StartChallenge() {
      if (!w1ChallengeUnlocked || w1ChallengeActive) return;
      w1ChallengeActive = true;
      w1ChallengeScore = 0;
      w1ChallengeTimeLeft = 60;

      w1CurrentLevelIndex = 2;
      w1CorrectInLevel = 0;
      w1UpdateDiffButtons();

      w1LevelLabelEl.textContent = "æŒ‘æˆ˜æ¨¡å¼ï¼š1 åˆ†é’Ÿé€Ÿæˆ˜";
      w1LevelProgressEl.textContent = "-";
      w1FeedbackEl.textContent = "";
      w1FeedbackEl.className = "feedback";

      w1BtnRestart.disabled = true;
      w1BtnHelp.disabled = true;
      w1BtnNext.disabled = true;

      w1TowerTipEl.style.display = "none";

      w1ChallengeStatusEl.textContent =
        `æŒ‘æˆ˜æ¨¡å¼è¿›è¡Œä¸­ï¼šå‰©ä½™ ${w1ChallengeTimeLeft} ç§’ï¼Œå·²ç­”å¯¹ 0 é¢˜ã€‚`;

      if (w1ChallengeTimerId) clearInterval(w1ChallengeTimerId);
      w1ChallengeTimerId = setInterval(() => {
        w1ChallengeTimeLeft--;
        if (w1ChallengeTimeLeft <= 0) {
          w1EndChallenge();
        } else {
          w1ChallengeStatusEl.textContent =
            `æŒ‘æˆ˜æ¨¡å¼è¿›è¡Œä¸­ï¼šå‰©ä½™ ${w1ChallengeTimeLeft} ç§’ï¼Œå·²ç­”å¯¹ ${w1ChallengeScore} é¢˜ã€‚`;
        }
      }, 1000);

      w1NewQuestion();
    }

    function w1EndChallenge() {
      if (!w1ChallengeActive) return;
      w1ChallengeActive = false;
      clearInterval(w1ChallengeTimerId);
      w1ChallengeTimerId = null;

      w1ChallengeStatusEl.textContent =
        `æœ¬è½®ç»“æŸï¼šä½ åœ¨ 60 ç§’å†…ä¸€å…±ç­”å¯¹äº† ${w1ChallengeScore} é¢˜ï¼å¯ä»¥å†è¯•ä¸€æ¬¡æŒ‘æˆ˜ï¼Œæˆ–è€…å›åˆ°æ™®é€šæ¨¡å¼ç»§ç»­ç»ƒä¹ ã€‚`;

      w1BtnRestart.disabled = false;
      w1BtnHelp.disabled = false;
      w1BtnNext.disabled = false;

      w1CurrentLevelIndex = 2;
      w1UpdateLevelUI();

      w1UpdateLeaderboard(w1ChallengeScore);
    }

    w1BtnChallenge.addEventListener("click", () => {
      if (!w1ChallengeUnlocked) return;
      w1StartChallenge();
    });

    function w1Init() {
      w1LoadChallengeUnlock();
      w1RenderLeaderboard();
      w1UpdateDiffButtons();
      w1UpdateLevelUI();
      w1NewQuestion();
    }

    /* ================== ä¸–ç•ŒäºŒï¼šå‡å’Œæ¯«å‡å®éªŒå®¤ ================== */

    const w2Levels = [
      {
        id: 1,
        name: "Lv.1 ç®€å• Â· ç›´æ¥æ¢ç®—",
        tip: "å…ˆè®°ä½ï¼š1 å‡ = 1000 æ¯«å‡ã€‚æœ¬å…³ä¸»è¦æ˜¯ L å’Œ mL çš„ç®€å•æ¢ç®—ã€‚"
      },
      {
        id: 2,
        name: "Lv.2 ä¸­ç­‰ Â· ç»„åˆå®¹é‡",
        tip: "é‡åˆ°â€œå‡ å‡å‡ æ¯«å‡â€ï¼Œå¯ä»¥å…ˆæŠŠâ€œå‡ å‡â€éƒ½å˜æˆæ¯«å‡ï¼Œå†åŠ ä¸Šå‰©ä¸‹çš„æ¯«å‡ã€‚"
      },
      {
        id: 3,
        name: "Lv.3 å›°éš¾ Â· æƒ…æ™¯åº”ç”¨",
        tip: "è¦ä»”ç»†è¯»é¢˜ï¼Œçœ‹æ¸…æ¥šé—®çš„æ˜¯â€œæ€»å…±å¤šå°‘æ¯«å‡â€è¿˜æ˜¯â€œå¤šå°‘å‡å¤šå°‘æ¯«å‡â€ã€‚"
      }
    ];

    let w2CurrentLevelIndex = 0;
    let w2CorrectInLevel = 0;
    let w2LevelCleared = [false,false,false];
    let w2TotalScore = 0;

    let w2CurrentQuestion = null;
    let w2Answered = false;

    let w2ChallengeUnlocked = false;
    let w2ChallengeActive = false;
    let w2ChallengeScore = 0;
    let w2ChallengeTimeLeft = 0;
    let w2ChallengeTimerId = null;

    const w2LevelLabelEl = document.getElementById("w2-level-label");
    const w2LevelProgressEl = document.getElementById("w2-level-progress");
    const w2TotalScoreEl = document.getElementById("w2-total-score");
    const w2QuestionTextEl = document.getElementById("w2-question-text");
    const w2CapacityDisplayEl = document.getElementById("w2-capacity-display");
    const w2CapacityTipEl = document.getElementById("w2-capacity-tip");
    const w2OptionsGridEl = document.getElementById("w2-options-grid");
    const w2FeedbackEl = document.getElementById("w2-feedback");
    const w2BtnNext = document.getElementById("w2-btn-next");
    const w2BtnRestart = document.getElementById("w2-btn-restart");
    const w2BtnHelp = document.getElementById("w2-btn-help");
    const w2BtnChallenge = document.getElementById("w2-btn-challenge");
    const w2ChallengeStatusEl = document.getElementById("w2-challenge-status");
    const w2LeaderboardEl = document.getElementById("w2-leaderboard");
    const w2DiffButtons = [
      document.getElementById("w2-btn-level-0"),
      document.getElementById("w2-btn-level-1"),
      document.getElementById("w2-btn-level-2")
    ];

    function w2UpdateLevelUI() {
      const level = w2Levels[w2CurrentLevelIndex];
      w2LevelLabelEl.textContent = level.name;
      w2LevelProgressEl.textContent = `${w2CorrectInLevel} / 5`;
      if (!w2ChallengeActive) {
        w2CapacityTipEl.style.display = "flex";
        w2CapacityTipEl.firstChild && (w2CapacityTipEl.firstChild.textContent = "æç¤ºï¼š");
      } else {
        w2CapacityTipEl.style.display = "none";
      }
    }

    function w2UpdateDiffButtons() {
      w2DiffButtons.forEach((btn, idx) => {
        btn.classList.toggle("active", idx === w2CurrentLevelIndex);
        if (w2LevelCleared[idx]) btn.classList.add("cleared");
        else btn.classList.remove("cleared");
      });
    }

    w2DiffButtons.forEach((btn, idx) => {
      btn.addEventListener("click", () => {
        if (w2ChallengeActive) return;
        w2CurrentLevelIndex = idx;
        w2CorrectInLevel = 0;
        w2UpdateDiffButtons();
        w2UpdateLevelUI();
        w2FeedbackEl.textContent = "";
        w2FeedbackEl.className = "feedback";
        w2NewQuestion();
      });
    });

    function w2NewQuestion() {
      const levelIdx = w2CurrentLevelIndex;
      w2Answered = false;
      w2FeedbackEl.textContent = "";
      w2FeedbackEl.className = "feedback";
      w2BtnNext.disabled = true;

      let q = null;

      if (levelIdx === 0) {
        // ç®€å•ï¼šL <-> mL ç›´æ¥æ¢ç®—
        const direction = Math.random() < 0.5 ? "L_TO_ML" : "ML_TO_L";
        if (direction === "L_TO_ML") {
          const L = randInt(1, 9);
          const correct = L * 1000;
          q = {
            type: "L_TO_ML",
            text: `æŠŠ ${L} å‡æ¢ç®—æˆæ¯«å‡æ˜¯å¤šå°‘ï¼Ÿ`,
            display: `${L} L = ï¼Ÿ mL`,
            correct,
            explain: `1 å‡ = 1000 æ¯«å‡ï¼Œæ‰€ä»¥ ${L} å‡ = ${L} Ã— 1000 = ${correct} æ¯«å‡ã€‚`
          };
        } else {
          const k = randInt(1, 9);
          const ml = k * 1000;
          const correct = k;
          q = {
            type: "ML_TO_L",
            text: `æŠŠ ${ml} æ¯«å‡æ¢ç®—æˆå‡æ˜¯å¤šå°‘ï¼Ÿ`,
            display: `${ml} mL = ï¼Ÿ L`,
            correct,
            explain: `1 å‡ = 1000 æ¯«å‡ï¼Œæ‰€ä»¥ ${ml} Ã· 1000 = ${correct} å‡ã€‚`
          };
        }
      } else if (levelIdx === 1) {
        // ä¸­ç­‰ï¼šç»„åˆå®¹é‡ -> æ€»æ¯«å‡
        const L = randInt(1, 5);
        const ml = randInt(100, 900);
        const correct = L * 1000 + ml;
        q = {
          type: "LML_TO_ML",
          text: `${L} å‡ ${ml} æ¯«å‡ä¸€å…±æ˜¯å¤šå°‘æ¯«å‡ï¼Ÿ`,
          display: `${L} L ${ml} mL = ï¼Ÿ mL`,
          correct,
          explain:
            `${L} å‡å…ˆå˜æˆæ¯«å‡ï¼š${L} Ã— 1000 = ${L * 1000} æ¯«å‡ï¼Œå†åŠ ä¸Š ${ml} æ¯«å‡ï¼š` +
            `${L * 1000} + ${ml} = ${correct} æ¯«å‡ã€‚`
        };
      } else {
        // å›°éš¾ï¼šæƒ…æ™¯é¢˜
        const bottles = randInt(2, 4);
        const eachL = randInt(1, 3);
        const extraMl = randInt(100, 900);
        const totalMl = bottles * eachL * 1000 + extraMl;
        const Lpart = Math.floor(totalMl / 1000);
        const Mlpart = totalMl % 1000;
        q = {
          type: "SCENE",
          text: `æœ‰ ${bottles} ç“¶æœæ±ï¼Œæ¯ç“¶ ${eachL} å‡ï¼Œå¦å¤–è¿˜æœ‰ ${extraMl} æ¯«å‡ï¼Œä¸€å…±æœ‰å¤šå°‘å‡å¤šå°‘æ¯«å‡ï¼Ÿ`,
          display: `æ€»é‡ = ï¼Ÿ L ï¼Ÿ mL`,
          correct: `${Lpart}L${Mlpart}mL`,
          Lpart,
          Mlpart,
          explain:
            `${bottles} ç“¶ Ã— æ¯ç“¶ ${eachL} å‡ = ${bottles * eachL} å‡ = ${bottles * eachL * 1000} æ¯«å‡ï¼Œ` +
            `å†åŠ ä¸Š ${extraMl} æ¯«å‡ï¼š${bottles * eachL * 1000} + ${extraMl} = ${totalMl} æ¯«å‡ã€‚\n` +
            `${totalMl} æ¯«å‡é‡Œé¢æœ‰å¤šå°‘ä¸ª 1000ï¼Ÿ${Lpart} ä¸ªï¼Œå°±æ˜¯ ${Lpart} å‡ï¼Œè¿˜å‰© ${Mlpart} æ¯«å‡ã€‚`
        };
      }

      w2CurrentQuestion = q;
      w2QuestionTextEl.textContent = "é¢˜ç›®ï¼š" + q.text;
      w2CapacityDisplayEl.textContent = q.display;

      if (w2ChallengeActive) {
        w2CapacityTipEl.style.display = "none";
      } else {
        w2CapacityTipEl.style.display = "flex";
      }

      w2BuildOptions(q);
    }

    function w2BuildOptions(q) {
      w2OptionsGridEl.innerHTML = "";
      const options = new Set();

      if (q.type === "SCENE") {
        const correctStr = q.correct;
        options.add(correctStr);

        while (options.size < 4) {
          let dL = q.Lpart + randInt(-1, 1);
          if (dL < 0) dL = 0;
          let dMl = q.Mlpart + randInt(-200, 200);
          if (dMl < 0) dMl = 0;
          const s = `${dL}L${dMl}mL`;
          if (s !== correctStr) options.add(s);
        }
      } else {
        const correct = q.correct;
        options.add(correct);
        while (options.size < 4) {
          let delta = randInt(-2000, 2000);
          if (delta === 0) continue;
          const v = correct + delta;
          if (v > 0) options.add(v);
        }
      }

      shuffle(Array.from(options)).forEach(val => {
        const btn = document.createElement("button");
        btn.className = "num-btn";
        btn.textContent = typeof val === "number" ? val : val;
        btn.addEventListener("click", () => w2HandleAnswer(val, btn));
        w2OptionsGridEl.appendChild(btn);
      });
    }

    function w2HandleAnswer(choice, btn) {
      if (w2Answered) return;
      w2Answered = true;

      w2OptionsGridEl.querySelectorAll(".num-btn").forEach(b => b.disabled = true);

      const q = w2CurrentQuestion;
      const isCorrect =
        q.type === "SCENE" ? (choice === q.correct) : (choice === q.correct);

      if (isCorrect) {
        btn.classList.add("correct");
        w2FeedbackEl.className = "feedback ok";

        if (w2ChallengeActive) {
          w2ChallengeScore += 1;
          w2FeedbackEl.textContent =
            `âœ… å¤ªæ£’äº†ï¼ä½ åœ¨æŒ‘æˆ˜æ¨¡å¼ä¸­åˆç­”å¯¹äº†ä¸€é¢˜ï¼Œç›®å‰æ€»å…±ç­”å¯¹ ${w2ChallengeScore} é¢˜ã€‚`;
          w2ChallengeStatusEl.textContent =
            `æŒ‘æˆ˜æ¨¡å¼è¿›è¡Œä¸­ï¼šå‰©ä½™ ${w2ChallengeTimeLeft} ç§’ï¼Œå·²ç­”å¯¹ ${w2ChallengeScore} é¢˜ã€‚`;
        } else {
          w2FeedbackEl.textContent =
            `âœ… å›ç­”æ­£ç¡®ï¼${q.explain}`;

          w2CorrectInLevel += 1;
          w2TotalScore += 10;
          w2TotalScoreEl.textContent = w2TotalScore;
          w2LevelProgressEl.textContent = `${w2CorrectInLevel} / 5`;

          if (w2CorrectInLevel >= 5 && !w2LevelCleared[w2CurrentLevelIndex]) {
            w2LevelCleared[w2CurrentLevelIndex] = true;
            w2UpdateDiffButtons();
            w2FeedbackEl.textContent +=
              ` ğŸ‰ ä½ å·²ç»å®Œæˆâ€œ${w2Levels[w2CurrentLevelIndex].name}â€çš„ 5 é¢˜æŒ‘æˆ˜ï¼Œå¯ä»¥ç»§ç»­ç»ƒä¹ æˆ–åˆ‡æ¢ç­‰çº§ã€‚`;

            if (w2LevelCleared.every(v => v)) {
              w2UnlockChallenge();
            }
          }
        }
      } else {
        btn.classList.add("wrong");
        w2FeedbackEl.className = "feedback bad";

        if (!w2ChallengeActive) {
          let wrongExplain = "";
          if (q.type === "L_TO_ML") {
            wrongExplain =
              `âŒ è¿™æ¬¡æ¢ç®—ä¸å¯¹ã€‚\nä½ éœ€è¦è®°ä½ï¼š1 å‡ = 1000 æ¯«å‡ï¼Œæ‰€ä»¥è¦ç”¨â€œå‡ Ã— 1000â€çš„æ–¹æ³•æ¥ç®—ã€‚`;
          } else if (q.type === "ML_TO_L") {
            wrongExplain =
              `âŒ è¿™æ¬¡æ¢ç®—ä¸å¯¹ã€‚\nä½ éœ€è¦æŠŠæ¯«å‡é™¤ä»¥ 1000ï¼Œçœ‹çœ‹é‡Œé¢æœ‰å‡ ä¸ªâ€œ1000 æ¯«å‡â€ï¼Œé‚£å°±æ˜¯å¤šå°‘å‡ã€‚`;
          } else if (q.type === "LML_TO_ML") {
            wrongExplain =
              `âŒ è¿™æ¬¡æ²¡æœ‰æŠŠâ€œå‡â€å…¨éƒ¨å…ˆå˜æˆæ¯«å‡ã€‚\nå…ˆç®—â€œå‡ å‡ Ã— 1000â€ï¼Œå†åŠ ä¸Šåé¢çš„æ¯«å‡ï¼Œä¼šæ›´ç¨³ã€‚`;
          } else {
            wrongExplain =
              `âŒ è¿™æ¬¡æ²¡æœ‰çœ‹æ¸…æ¥šé¢˜ç›®æƒ³è¦â€œå¤šå°‘å‡å¤šå°‘æ¯«å‡â€ã€‚\nå…ˆæŠŠæ€»æ¯«å‡ç®—å‡ºæ¥ï¼Œå†æ‹†æˆâ€œå¤šå°‘å‡ + å‰©ä¸‹å¤šå°‘æ¯«å‡â€ã€‚`;
          }
          w2FeedbackEl.textContent = wrongExplain + "\n\næ­£ç¡®æ€è·¯æ˜¯ï¼š\n" + q.explain;
        } else {
          w2FeedbackEl.textContent =
            `âŒ è¿™é¢˜æ²¡å¯¹ï¼ŒæŒ‘æˆ˜æ¨¡å¼ä¸‹ä¸ç»™è¯¦ç»†æç¤ºï¼Œé å¹³æ—¶å­¦åˆ°çš„æ–¹æ³•å†å†²ä¸€é¢˜ï¼`;
        }
      }

      w2BtnNext.disabled = false;
      if (w2ChallengeActive) {
        setTimeout(() => { w2NewQuestion(); }, 350);
      }
    }

    w2BtnNext.addEventListener("click", () => {
      if (w2ChallengeActive) return;
      w2NewQuestion();
    });

    w2BtnRestart.addEventListener("click", () => {
      if (w2ChallengeActive) return;
      w2CorrectInLevel = 0;
      w2UpdateLevelUI();
      w2FeedbackEl.textContent = "";
      w2FeedbackEl.className = "feedback";
      w2NewQuestion();
    });

    w2BtnHelp.addEventListener("click", () => {
      if (w2ChallengeActive) return;
      const level = w2Levels[w2CurrentLevelIndex];
      w2FeedbackEl.className = "feedback";
      w2FeedbackEl.textContent =
        `ğŸ” å°æç¤ºï¼š${level.tip}\nè®°ä½ä¸€ä¸ªæ ¸å¿ƒï¼š1 å‡ = 1000 æ¯«å‡ã€‚`;
    });

    function w2GetLeaderboard() {
      try {
        const raw = localStorage.getItem("g4_world2_leaderboard");
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch { return []; }
    }

    function w2SaveLeaderboard(list) {
      try { localStorage.setItem("g4_world2_leaderboard", JSON.stringify(list)); } catch {}
    }

    function w2RenderLeaderboard() {
      const list = w2GetLeaderboard();
      if (!list.length) {
        w2LeaderboardEl.textContent = "æŒ‘æˆ˜æ’è¡Œæ¦œï¼šè¿˜æ²¡æœ‰è®°å½•ï¼Œå¿«æ¥æˆä¸ºç¬¬ä¸€ä¸ªå§ï¼";
        return;
      }
      let html = "<strong>æŒ‘æˆ˜æ’è¡Œæ¦œï¼ˆ60 ç§’å†…ç­”å¯¹é¢˜æ•°ï¼‰ï¼š</strong><br>";
      list.forEach((item, idx) => {
        const d = new Date(item.time);
        const label =
          `${d.getMonth()+1}/${d.getDate()} ` +
          `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
        html += `${idx+1}. ${item.score} é¢˜ï¼ˆ${label}ï¼‰<br>`;
      });
      w2LeaderboardEl.innerHTML = html;
    }

    function w2UpdateLeaderboard(score) {
      let list = w2GetLeaderboard();
      list.push({ score, time: Date.now() });
      list.sort((a,b) => b.score !== a.score ? b.score - a.score : a.time - b.time);
      list = list.slice(0, 5);
      w2SaveLeaderboard(list);
      w2RenderLeaderboard();
    }

    function w2UnlockChallenge() {
      if (w2ChallengeUnlocked) return;
      w2ChallengeUnlocked = true;
      try { localStorage.setItem("g4_world2_challenge_unlocked", "1"); } catch {}
      w2BtnChallenge.disabled = false;
      w2BtnChallenge.textContent = "ğŸ”¥ æŒ‘æˆ˜æ¨¡å¼ï¼š1 åˆ†é’Ÿå®¹é‡é€Ÿæˆ˜ï¼ˆå·²è§£é”ï¼Œç‚¹å‡»å¼€å§‹ï¼‰";
      w2ChallengeStatusEl.textContent =
        "æŒ‘æˆ˜æ¨¡å¼å·²è§£é”ï¼š60 ç§’å†…çœ‹ä½ èƒ½åšå¯¹å¤šå°‘é“å®¹é‡æ¢ç®—é¢˜ï¼";
    }

    function w2LoadChallengeUnlock() {
      try {
        const flag = localStorage.getItem("g4_world2_challenge_unlocked");
        if (flag === "1") {
          w2ChallengeUnlocked = true;
          w2BtnChallenge.disabled = false;
          w2BtnChallenge.textContent = "ğŸ”¥ æŒ‘æˆ˜æ¨¡å¼ï¼š1 åˆ†é’Ÿå®¹é‡é€Ÿæˆ˜ï¼ˆå·²è§£é”ï¼Œç‚¹å‡»å¼€å§‹ï¼‰";
          w2ChallengeStatusEl.textContent =
            "æŒ‘æˆ˜æ¨¡å¼å·²è§£é”ï¼š60 ç§’å†…çœ‹ä½ èƒ½åšå¯¹å¤šå°‘é“å®¹é‡æ¢ç®—é¢˜ï¼";
        }
      } catch {}
    }

    function w2StartChallenge() {
      if (!w2ChallengeUnlocked || w2ChallengeActive) return;
      w2ChallengeActive = true;
      w2ChallengeScore = 0;
      w2ChallengeTimeLeft = 60;

      w2CurrentLevelIndex = 2;
      w2CorrectInLevel = 0;
      w2UpdateDiffButtons();

      w2LevelLabelEl.textContent = "æŒ‘æˆ˜æ¨¡å¼ï¼š1 åˆ†é’Ÿå®¹é‡é€Ÿæˆ˜";
      w2LevelProgressEl.textContent = "-";
      w2FeedbackEl.textContent = "";
      w2FeedbackEl.className = "feedback";

      w2BtnRestart.disabled = true;
      w2BtnHelp.disabled = true;
      w2BtnNext.disabled = true;

      w2CapacityTipEl.style.display = "none";

      w2ChallengeStatusEl.textContent =
        `æŒ‘æˆ˜æ¨¡å¼è¿›è¡Œä¸­ï¼šå‰©ä½™ ${w2ChallengeTimeLeft} ç§’ï¼Œå·²ç­”å¯¹ 0 é¢˜ã€‚`;

      if (w2ChallengeTimerId) clearInterval(w2ChallengeTimerId);
      w2ChallengeTimerId = setInterval(() => {
        w2ChallengeTimeLeft--;
        if (w2ChallengeTimeLeft <= 0) {
          w2EndChallenge();
        } else {
          w2ChallengeStatusEl.textContent =
            `æŒ‘æˆ˜æ¨¡å¼è¿›è¡Œä¸­ï¼šå‰©ä½™ ${w2ChallengeTimeLeft} ç§’ï¼Œå·²ç­”å¯¹ ${w2ChallengeScore} é¢˜ã€‚`;
        }
      }, 1000);

      w2NewQuestion();
    }

    function w2EndChallenge() {
      if (!w2ChallengeActive) return;
      w2ChallengeActive = false;
      clearInterval(w2ChallengeTimerId);
      w2ChallengeTimerId = null;

      w2ChallengeStatusEl.textContent =
        `æœ¬è½®ç»“æŸï¼šä½ åœ¨ 60 ç§’å†…ä¸€å…±ç­”å¯¹äº† ${w2ChallengeScore} é¢˜ï¼å¯ä»¥å†è¯•ä¸€æ¬¡æŒ‘æˆ˜ï¼Œæˆ–è€…å›åˆ°æ™®é€šæ¨¡å¼ç»§ç»­ç»ƒä¹ ã€‚`;

      w2BtnRestart.disabled = false;
      w2BtnHelp.disabled = false;
      w2BtnNext.disabled = false;

      w2CurrentLevelIndex = 2;
      w2UpdateLevelUI();

      w2UpdateLeaderboard(w2ChallengeScore);
    }

    w2BtnChallenge.addEventListener("click", () => {
      if (!w2ChallengeUnlocked) return;
      w2StartChallenge();
    });

    function w2Init() {
      w2LoadChallengeUnlock();
      w2RenderLeaderboard();
      w2UpdateDiffButtons();
      w2UpdateLevelUI();
      w2NewQuestion();
    }

    /* ============== æ•´ä½“åˆå§‹åŒ– ============== */
    (function mainInit() {
      w1Init();
      w2Init();
    })();
  </script>
</body>
</html>
